

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>neuropype_graph.nodes.correl_mat &mdash; neuropype 0.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="neuropype 0.0 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../../index.html" class="fa fa-home"> neuropype</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../ephypype/neuropype_ephy.html">neuropype_ephy</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../ephypype/neuropype_ephy.html#pipelines">Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ephypype/neuropype_ephy.html#installation">Installation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://dmalt.github.io/neuropype_cli/">neuropype_cli</a></li>
<li class="toctree-l1"><a class="reference external" href="http://davidmeunier79.github.io/neuropype_graph/">neuropype_graph</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/examples.html">Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/preproc_example.html">From raw data to preprocessed data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/power_example.html">PSD pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/conn_graph_example.html">Spectral connectivity and graph pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/inv_example.html">Source reconstruction pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/examples.html#scripts">Scripts</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cinq/cinq.html">CINQ</a></li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">neuropype</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>neuropype_graph.nodes.correl_mat</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for neuropype_graph.nodes.correl_mat</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Definition of Nodes for computing correlation matrices </span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c">#import nipy.labs.statistical_mapping as stat_map</span>

<span class="c">#import itertools as iter</span>
    
<span class="c">#import scipy.spatial.distance as dist</span>
    
<span class="kn">from</span> <span class="nn">nipype.interfaces.base</span> <span class="kn">import</span> <span class="n">BaseInterface</span><span class="p">,</span> \
    <span class="n">BaseInterfaceInputSpec</span><span class="p">,</span> <span class="n">traits</span><span class="p">,</span> <span class="n">File</span><span class="p">,</span> <span class="n">TraitedSpec</span><span class="p">,</span> <span class="n">isdefined</span>
    
<span class="kn">from</span> <span class="nn">nipype.utils.filemanip</span> <span class="kn">import</span> <span class="n">split_filename</span> <span class="k">as</span> <span class="n">split_f</span>
    
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="kn">as</span> <span class="nn">nb</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">nibabel</span> <span class="kn">as</span> <span class="nn">nib</span>

<span class="kn">from</span> <span class="nn">neuropype_graph.utils_plot</span> <span class="kn">import</span> <span class="n">plot_signals</span><span class="p">,</span><span class="n">plot_sep_signals</span>
        
<span class="c">######################################################################################## ExtractTS ##################################################################################################################</span>

<span class="kn">from</span> <span class="nn">neuropype_graph.utils_cor</span> <span class="kn">import</span> <span class="n">mean_select_indexed_mask_data</span>

<span class="k">class</span> <span class="nc">ExtractTSInputSpec</span><span class="p">(</span><span class="n">BaseInterfaceInputSpec</span><span class="p">):</span>
    <span class="n">indexed_rois_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;indexed mask where all voxels belonging to the same ROI have the same value (! starting from 1)&#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="n">file_4D</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;4D volume to be extracted&#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="n">coord_rois_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s">&#39;ROI coordinates&#39;</span><span class="p">)</span>
    
    <span class="n">min_BOLD_intensity</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="mf">50.0</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;BOLD signal below this value will be set to zero&#39;</span><span class="p">,</span><span class="n">usedefault</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

    <span class="n">percent_signal</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">desc</span>  <span class="o">=</span> <span class="s">&quot;Percent of voxels in a ROI with signal higher that min_BOLD_intensity to keep this ROI&quot;</span><span class="p">,</span><span class="n">usedefault</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
    
    <span class="n">plot_fig</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Plotting mean signal or not&quot;</span><span class="p">,</span> <span class="n">usedefault</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
    
    
<span class="k">class</span> <span class="nc">ExtractTSOutputSpec</span><span class="p">(</span><span class="n">TraitedSpec</span><span class="p">):</span>
    
    <span class="n">mean_masked_ts_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&quot;mean ts in .npy (pickle format)&quot;</span><span class="p">)</span>
    
    <span class="n">subj_coord_rois_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&quot;ROI coordinates retained for the subject&quot;</span><span class="p">)</span>
    

<div class="viewcode-block" id="ExtractTS"><a class="viewcode-back" href="../../../graphpype/correl_mat.html#neuropype_graph.nodes.correl_mat.ExtractTS">[docs]</a><span class="k">class</span> <span class="nc">ExtractTS</span><span class="p">(</span><span class="n">BaseInterface</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    </span>
<span class="sd">    Description: Extract time series from a labelled mask in Nifti Format where all ROIs have the same index</span>
<span class="sd">    </span>
<span class="sd">    Inputs:</span>
<span class="sd">    </span>
<span class="sd">        indexed_rois_file:</span>
<span class="sd">            type = File, exists=True, desc=&#39;indexed mask where all voxels belonging to the same ROI have the same value (! starting from 1)&#39;, mandatory=True</span>
<span class="sd">        </span>
<span class="sd">        file_4D:</span>
<span class="sd">            type = File, exists=True, desc=&#39;4D volume to be extracted&#39;, mandatory=True</span>
<span class="sd">        </span>
<span class="sd">        coord_rois_file:</span>
<span class="sd">            type = File, desc=&#39;ROI coordinates&#39;</span>
<span class="sd">        </span>
<span class="sd">        min_BOLD_intensity:</span>
<span class="sd">            type = Float, default = 50.0, desc=&#39;BOLD signal below this value will be set to zero&#39;,usedefault = True</span>

<span class="sd">        percent_signal:</span>
<span class="sd">            type = Float, default = 0.5, desc  = &quot;Percent of voxels in a ROI with signal higher that min_BOLD_intensity to keep this ROI&quot;,usedefault = True</span>
<span class="sd">        </span>
<span class="sd">        plot_fig:</span>
<span class="sd">            type = Bool, defaults = False, desc = &quot;Plotting mean signal or not&quot;, usedefault = True)</span>
<span class="sd">        </span>
<span class="sd">    Outputs:</span>
<span class="sd">        </span>
<span class="sd">        mean_masked_ts_file: </span>
<span class="sd">            type = File, exists=True, desc=&quot;mean ts in .npy (pickle format)&quot;</span>
<span class="sd">    </span>
<span class="sd">        subj_coord_rois_file: </span>
<span class="sd">            type = File, exists=True, desc=&quot;ROI coordinates retained for the subject&quot;</span>
<span class="sd">            </span>
<span class="sd">            </span>
<span class="sd">    </span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">input_spec</span> <span class="o">=</span> <span class="n">ExtractTSInputSpec</span>
    <span class="n">output_spec</span> <span class="o">=</span> <span class="n">ExtractTSOutputSpec</span>

    <span class="k">def</span> <span class="nf">_run_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runtime</span><span class="p">):</span>
              
        <span class="n">coord_rois_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">coord_rois_file</span>
        <span class="n">indexed_rois_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">indexed_rois_file</span>
        <span class="n">file_4D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">file_4D</span>
        <span class="n">min_BOLD_intensity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">min_BOLD_intensity</span>
        
        <span class="n">plot_fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">plot_fig</span>
        
        <span class="c">## loading ROI coordinates</span>
        <span class="n">coord_rois</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">coord_rois_file</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="s">&quot;coord_rois: &quot;</span> 
        <span class="k">print</span> <span class="n">coord_rois</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="c">## loading ROI indexed mask</span>
        <span class="n">indexed_rois_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">indexed_rois_file</span><span class="p">)</span>
        <span class="n">indexed_mask_rois_data</span> <span class="o">=</span> <span class="n">indexed_rois_img</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        
        <span class="c">### loading time series</span>
        <span class="n">orig_ts</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_4D</span><span class="p">)</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        
        <span class="k">print</span> <span class="s">&quot;orig_ts shape:&quot;</span>
        <span class="k">print</span> <span class="n">orig_ts</span><span class="o">.</span><span class="n">shape</span>
            
        <span class="n">mean_masked_ts</span><span class="p">,</span><span class="n">subj_coord_rois</span> <span class="o">=</span> <span class="n">mean_select_indexed_mask_data</span><span class="p">(</span><span class="n">orig_ts</span><span class="p">,</span><span class="n">indexed_mask_rois_data</span><span class="p">,</span><span class="n">coord_rois</span><span class="p">,</span><span class="n">min_BOLD_intensity</span><span class="p">,</span> <span class="n">percent_signal</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
        
        <span class="n">mean_masked_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mean_masked_ts</span><span class="p">,</span><span class="n">dtype</span> <span class="o">=</span> <span class="s">&#39;f&#39;</span><span class="p">)</span>
        <span class="n">subj_coord_rois</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">subj_coord_rois</span><span class="p">,</span><span class="n">dtype</span> <span class="o">=</span> <span class="s">&#39;float&#39;</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="n">mean_masked_ts</span><span class="o">.</span><span class="n">shape</span>
            
        <span class="c">### saving time series</span>
        <span class="n">mean_masked_ts_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&quot;mean_masked_ts.txt&quot;</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">mean_masked_ts_file</span><span class="p">,</span><span class="n">mean_masked_ts</span><span class="p">,</span><span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%.3f</span><span class="s">&#39;</span><span class="p">)</span>
        
        <span class="c">### saving subject ROIs</span>
        <span class="n">subj_coord_rois_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&quot;subj_coord_rois.txt&quot;</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">subj_coord_rois_file</span><span class="p">,</span><span class="n">subj_coord_rois</span><span class="p">,</span><span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%.3f</span><span class="s">&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">plot_fig</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                
            <span class="k">print</span> <span class="s">&quot;plotting mean_masked_ts&quot;</span>
            
            <span class="n">plot_mean_masked_ts_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;mean_masked_ts.eps&#39;</span><span class="p">)</span>    
            
            <span class="n">plot_signals</span><span class="p">(</span><span class="n">plot_mean_masked_ts_file</span><span class="p">,</span><span class="n">mean_masked_ts</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">runtime</span>
        
        <span class="c">#return mean_masked_ts_file,subj_coord_rois_file</span>
        
    <span class="k">def</span> <span class="nf">_list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        
        <span class="n">outputs</span><span class="p">[</span><span class="s">&quot;mean_masked_ts_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&quot;mean_masked_ts.txt&quot;</span><span class="p">)</span>
        <span class="n">outputs</span><span class="p">[</span><span class="s">&quot;subj_coord_rois_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&quot;subj_coord_rois.txt&quot;</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">outputs</span>


<span class="c">######################################################################################## IntersectMask ##################################################################################################################</span>
</div>
<span class="kn">from</span> <span class="nn">neuropype_graph.utils_cor</span> <span class="kn">import</span> <span class="n">mean_select_indexed_mask_data</span>

<span class="k">class</span> <span class="nc">IntersectMaskInputSpec</span><span class="p">(</span><span class="n">BaseInterfaceInputSpec</span><span class="p">):</span>
    
    
    <span class="n">indexed_rois_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;nii file with indexed mask where all voxels belonging to the same ROI have the same value (! starting from 0)&#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="n">filter_mask_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span> <span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;nii file with (binary) mask - e.g. grey matter mask&#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="n">coords_rois_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s">&#39;ijk coords txt file&#39;</span><span class="p">)</span>
    
    <span class="n">labels_rois_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;labels txt file&#39;</span><span class="p">)</span>
    
    <span class="n">MNI_coords_rois_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s">&#39;MNI coords txt file&#39;</span><span class="p">)</span>
    
    <span class="n">filter_thr</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">usedefault</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Value to threshold filter_mask&#39;</span><span class="p">)</span>
                          
<span class="k">class</span> <span class="nc">IntersectMaskOutputSpec</span><span class="p">(</span><span class="n">TraitedSpec</span><span class="p">):</span>
    
    <span class="n">filtered_indexed_rois_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;nii file with indexed mask where all voxels belonging to the same ROI have the same value (! starting from 0)&#39;</span><span class="p">)</span>
    
    <span class="n">filtered_coords_rois_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;filtered ijk coords txt file&#39;</span><span class="p">)</span>    
    
    <span class="n">filtered_labels_rois_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;filtered labels txt file&#39;</span><span class="p">)</span>
    
    <span class="n">filtered_MNI_coords_rois_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;filtered MNI coords txt file&#39;</span><span class="p">)</span>
    
    


<div class="viewcode-block" id="IntersectMask"><a class="viewcode-back" href="../../../graphpype/correl_mat.html#neuropype_graph.nodes.correl_mat.IntersectMask">[docs]</a><span class="k">class</span> <span class="nc">IntersectMask</span><span class="p">(</span><span class="n">BaseInterface</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description:</span>
<span class="sd">        Keep only values of indexed mask where filtermask is present</span>
<span class="sd">        Optionnally, keep only ijk_coords, MNI_coords and labels that are kept in filtered mask</span>
<span class="sd">        </span>
<span class="sd">    Inputs:</span>
<span class="sd">            </span>
<span class="sd">        indexed_rois_file:</span>
<span class="sd">        </span>
<span class="sd">            type = File, exists=True, desc=&#39;nii file with indexed mask where all voxels belonging to the same ROI have the same value (! starting from 0)&#39;, mandatory=True</span>
<span class="sd">            </span>
<span class="sd">        filter_mask_file:</span>
<span class="sd">            type = File, exists=True, desc=&#39;nii file with (binary) mask - e.g. grey matter mask&#39;, mandatory=True</span>
<span class="sd">        </span>
<span class="sd">        coords_rois_file:</span>
<span class="sd">            type = File, desc=&#39;ijk coords txt file&#39;</span>
<span class="sd">            </span>
<span class="sd">        labels_rois_file:</span>
<span class="sd">            type = File, desc=&#39;labels txt file&#39;</span>
<span class="sd">            </span>
<span class="sd">        MNI_coords_rois_file:</span>
<span class="sd">            type = File, desc=&#39;MNI coords txt file&#39;</span>
<span class="sd">        </span>
<span class="sd">        filter_thr:</span>
<span class="sd">            type = Float, default = 0.99, usedefault = True, desc=&#39;Value to threshold filter_mask&#39;</span>
<span class="sd">                        </span>
<span class="sd">    Outputs:</span>
<span class="sd">    </span>
<span class="sd">        filtered_indexed_rois_file:</span>
<span class="sd">            type = File, exists=True, desc=&#39;nii file with indexed mask where all voxels belonging to the same ROI have the same value (! starting from 0)&#39;</span>
<span class="sd">        </span>
<span class="sd">        filtered_coords_rois_file:</span>
<span class="sd">            type = File, exists=False, desc=&#39;filtered ijk coords txt file&#39; </span>
<span class="sd">        </span>
<span class="sd">        filtered_labels_rois_file:</span>
<span class="sd">            type = File, exists=False, desc=&#39;filtered labels txt file&#39;</span>
<span class="sd">        </span>
<span class="sd">        filtered_MNI_coords_rois_file:</span>
<span class="sd">            type = File, exists=False, desc=&#39;filtered MNI coords txt file&#39;</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">input_spec</span> <span class="o">=</span> <span class="n">IntersectMaskInputSpec</span>
    <span class="n">output_spec</span> <span class="o">=</span> <span class="n">IntersectMaskOutputSpec</span>

    <span class="k">def</span> <span class="nf">_run_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runtime</span><span class="p">):</span>
            
        <span class="c">#import os</span>
        <span class="c">#import numpy as np</span>
        <span class="kn">import</span> <span class="nn">nibabel</span> <span class="kn">as</span> <span class="nn">nib</span>
        
        <span class="kn">import</span> <span class="nn">nipype.interfaces.spm</span> <span class="kn">as</span> <span class="nn">spm</span>

        <span class="c">#from neuropype_graph.utils_plot import plot_signals</span>
        
        <span class="n">indexed_rois_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">indexed_rois_file</span>
        <span class="n">filter_mask_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">filter_mask_file</span>
        <span class="n">coords_rois_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">coords_rois_file</span>
        <span class="n">labels_rois_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">labels_rois_file</span>
        <span class="n">MNI_coords_rois_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">MNI_coords_rois_file</span>
        <span class="n">filter_thr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">filter_thr</span> 
        
        <span class="k">print</span> <span class="n">filter_thr</span>
        
        <span class="c">## loading ROI indexed mask</span>
        <span class="n">indexed_rois_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">indexed_rois_file</span><span class="p">)</span>
        
        <span class="n">indexed_rois_data</span> <span class="o">=</span> <span class="n">indexed_rois_img</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        
        <span class="k">print</span> <span class="s">&quot;indexed_rois_data: &quot;</span>
        <span class="k">print</span> <span class="n">indexed_rois_data</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="c">### loading time series</span>
        <span class="n">filter_mask_data</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filter_mask_file</span><span class="p">)</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        
        <span class="k">print</span> <span class="s">&quot;filter_mask_data shape:&quot;</span>
        <span class="k">print</span> <span class="n">filter_mask_data</span><span class="o">.</span><span class="n">shape</span>
            
        <span class="k">if</span> <span class="n">filter_mask_data</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">indexed_rois_data</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            
            <span class="k">print</span> <span class="s">&quot;reslicing filtered_mask&quot;</span>
            
            
            <span class="n">reslice_filter_mask</span> <span class="o">=</span> <span class="n">spm</span><span class="o">.</span><span class="n">Reslice</span><span class="p">()</span>
            <span class="n">reslice_filter_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="n">filter_mask_file</span>
            <span class="n">reslice_filter_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">space_defining</span> <span class="o">=</span> <span class="n">indexed_rois_file</span>
            <span class="c">#reslice_filter_mask.inputs.out_file = os.path.abspath(&quot;resliced_filter_mask.nii&quot;)</span>
            
            <span class="n">resliced_filter_mask_file</span> <span class="o">=</span>  <span class="n">reslice_filter_mask</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out_file</span>

            <span class="n">filter_mask_data</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">resliced_filter_mask_file</span><span class="p">)</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        
        <span class="k">print</span> <span class="n">filter_mask_data</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">filter_mask_data</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">filter_mask_data</span> <span class="o">&gt;</span> <span class="n">filter_thr</span><span class="p">)</span>
        
        <span class="n">filter_mask_data</span><span class="p">[</span><span class="n">filter_mask_data</span> <span class="o">&gt;</span> <span class="n">filter_thr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">filter_mask_data</span><span class="p">[</span><span class="n">filter_mask_data</span> <span class="o">&lt;=</span> <span class="n">filter_thr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="c">#print np.unique(filter_mask_data)</span>
        <span class="k">print</span> <span class="s">&quot;indexed_rois_data:&quot;</span>
        <span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">indexed_rois_data</span><span class="p">)</span>        
        <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">indexed_rois_data</span><span class="p">))</span>
        
        <span class="n">filtered_indexed_rois_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">filter_mask_data</span> <span class="o">*</span> <span class="p">(</span><span class="n">indexed_rois_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span> <span class="o">=</span> <span class="s">&#39;int64&#39;</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="s">&quot;filtered_indexed_rois_data:&quot;</span>
        <span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">filtered_indexed_rois_data</span><span class="p">)</span>
        <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">filtered_indexed_rois_data</span><span class="p">))</span>
            
        <span class="n">filtered_indexed_rois_img_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&quot;filtered_indexed_rois.nii&quot;</span><span class="p">)</span>
        <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">filtered_indexed_rois_data</span><span class="p">,</span><span class="n">indexed_rois_img</span><span class="o">.</span><span class="n">get_affine</span><span class="p">(),</span><span class="n">indexed_rois_img</span><span class="o">.</span><span class="n">get_header</span><span class="p">()),</span><span class="n">filtered_indexed_rois_img_file</span><span class="p">)</span>
    
        <span class="k">print</span> <span class="s">&quot;index_corres:&quot;</span>
        <span class="c">#index_corres = np.unique(filtered_indexed_rois_data)[:-1]</span>
        <span class="n">index_corres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">filtered_indexed_rois_data</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
        
        <span class="k">print</span> <span class="n">index_corres</span>
        <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_corres</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="s">&quot;reorder_indexed_rois:&quot;</span>
        <span class="n">reorder_indexed_rois_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span> <span class="o">=</span> <span class="n">filtered_indexed_rois_data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span> <span class="o">=</span> <span class="s">&#39;int64&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">index_corres</span><span class="p">):</span>
            
            <span class="k">print</span> <span class="n">i</span><span class="p">,</span><span class="n">index</span>
            
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">filtered_indexed_rois_data</span> <span class="o">==</span> <span class="n">index</span><span class="p">,</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                
                <span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">filtered_indexed_rois_data</span> <span class="o">==</span> <span class="n">index</span><span class="p">,</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">))</span>
                <span class="n">reorder_indexed_rois_data</span><span class="p">[</span><span class="n">filtered_indexed_rois_data</span> <span class="o">==</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;Warning could not find value </span><span class="si">%d</span><span class="s"> in filtered_indexed_rois_data&quot;</span><span class="o">%</span><span class="n">index</span>
            
                                       
        <span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">reorder_indexed_rois_data</span><span class="p">)</span>  
        
        <span class="n">reorder_indexed_rois_img_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&quot;reorder_filtered_indexed_rois.nii&quot;</span><span class="p">)</span>
        <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">reorder_indexed_rois_data</span><span class="p">,</span><span class="n">indexed_rois_img</span><span class="o">.</span><span class="n">get_affine</span><span class="p">(),</span><span class="n">indexed_rois_img</span><span class="o">.</span><span class="n">get_header</span><span class="p">()),</span><span class="n">reorder_indexed_rois_img_file</span><span class="p">)</span>
    
    
        <span class="k">if</span> <span class="n">isdefined</span><span class="p">(</span><span class="n">coords_rois_file</span><span class="p">):</span>
            
            <span class="c">## loading ROI coordinates</span>
            <span class="k">print</span> <span class="s">&quot;coords_rois_file: &quot;</span>
            <span class="k">print</span> <span class="n">coords_rois_file</span>
            <span class="n">coords_rois</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">coords_rois_file</span><span class="p">)</span>
            
            <span class="k">print</span> <span class="s">&quot;coords_rois: &quot;</span> 
            <span class="k">print</span> <span class="n">coords_rois</span><span class="o">.</span><span class="n">shape</span>
            
            <span class="n">filtered_coords_rois</span> <span class="o">=</span> <span class="n">coords_rois</span><span class="p">[</span><span class="n">index_corres</span><span class="p">,:]</span>
            
            <span class="k">print</span> <span class="s">&quot;filtered_coords_rois: &quot;</span> 
            <span class="k">print</span> <span class="n">filtered_coords_rois</span>
            
            <span class="n">filtered_coords_rois_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&quot;filtered_coords_rois.txt&quot;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filtered_coords_rois_file</span><span class="p">,</span><span class="n">filtered_coords_rois</span><span class="p">,</span> <span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">isdefined</span><span class="p">(</span><span class="n">MNI_coords_rois_file</span><span class="p">):</span>
            
            <span class="c">## loading ROI coordinates</span>
            <span class="n">MNI_coords_rois</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">MNI_coords_rois_file</span><span class="p">)</span>
            
            <span class="k">print</span> <span class="s">&quot;MNI_coords_rois: &quot;</span> 
            <span class="k">print</span> <span class="n">MNI_coords_rois</span><span class="o">.</span><span class="n">shape</span>
            
            <span class="n">filtered_MNI_coords_rois</span> <span class="o">=</span> <span class="n">MNI_coords_rois</span><span class="p">[</span><span class="n">index_corres</span><span class="p">,:]</span>
            
            <span class="k">print</span> <span class="s">&quot;filtered_MNI_coords_rois: &quot;</span> 
            <span class="k">print</span> <span class="n">filtered_MNI_coords_rois</span>
            
            <span class="n">filtered_MNI_coords_rois_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&quot;filtered_MNI_coords_rois.txt&quot;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filtered_MNI_coords_rois_file</span><span class="p">,</span><span class="n">filtered_MNI_coords_rois</span><span class="p">,</span> <span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%f</span><span class="s">&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">isdefined</span><span class="p">(</span><span class="n">labels_rois_file</span><span class="p">):</span>
    
    
            <span class="k">print</span> <span class="s">&#39;extracting node labels&#39;</span>
                
            <span class="n">labels_rois</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">labels_rois_file</span><span class="p">)]</span>
            <span class="k">print</span> <span class="n">labels_rois</span>
            <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels_rois</span><span class="p">)</span>
            
            <span class="n">np_labels_rois</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels_rois</span><span class="p">,</span><span class="n">dtype</span> <span class="o">=</span> <span class="s">&#39;str&#39;</span><span class="p">)</span>
            
                
            <span class="n">filtered_labels_rois</span> <span class="o">=</span> <span class="n">np_labels_rois</span><span class="p">[</span><span class="n">index_corres</span><span class="p">]</span>
            
            <span class="k">print</span> <span class="s">&quot;filtered_coords_rois: &quot;</span> 
            <span class="k">print</span> <span class="n">filtered_coords_rois</span>
            
            <span class="n">filtered_labels_rois_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&quot;filtered_labels_rois.txt&quot;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filtered_labels_rois_file</span><span class="p">,</span><span class="n">filtered_labels_rois</span><span class="p">,</span> <span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">runtime</span>
        
        <span class="c">#return mean_masked_ts_file,subj_coord_rois_file</span>
        
    <span class="k">def</span> <span class="nf">_list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        
        <span class="n">outputs</span><span class="p">[</span><span class="s">&quot;filtered_indexed_rois_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&quot;reorder_filtered_indexed_rois.nii&quot;</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="n">isdefined</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">coords_rois_file</span><span class="p">):</span>
            <span class="n">outputs</span><span class="p">[</span><span class="s">&quot;filtered_coords_rois_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&quot;filtered_coords_rois.txt&quot;</span><span class="p">)</span>
            
        <span class="c">#outputs[&quot;filtered_MNI_coords_rois_file&quot;] = os.path.abspath(&quot;filtered_MNI_coords_rois.txt&quot;)</span>
        <span class="n">outputs</span><span class="p">[</span><span class="s">&quot;filtered_labels_rois_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&quot;filtered_labels_rois.txt&quot;</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">outputs</span>



<span class="c">############################################################################################### ExtractMeanTS #####################################################################################################</span>
</div>
<span class="kn">from</span> <span class="nn">neuropype_graph.utils_cor</span> <span class="kn">import</span> <span class="n">mean_select_mask_data</span>

<span class="k">class</span> <span class="nc">ExtractMeanTSInputSpec</span><span class="p">(</span><span class="n">BaseInterfaceInputSpec</span><span class="p">):</span>
    <span class="n">mask_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">xor</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;filter_mask_file&#39;</span><span class="p">],</span> <span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;mask file where all voxels belonging to the selected region have index 1&#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="n">filter_mask_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">xor</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;mask_file&#39;</span><span class="p">],</span><span class="n">requires</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;filter_thr&#39;</span><span class="p">],</span> <span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;mask file where all voxels belonging to the selected region have values higher than threshold&#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="n">filter_thr</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">usedefault</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Value to threshold filter_mask&#39;</span><span class="p">)</span>
    
    <span class="n">file_4D</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;4D volume to be extracted&#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="n">suffix</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s">&#39;Suffix added to describe the extracted time series&#39;</span><span class="p">,</span><span class="n">mandatory</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">plot_fig</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Plotting mean signal or not&quot;</span><span class="p">,</span> <span class="n">usedefault</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
    
<span class="k">class</span> <span class="nc">ExtractMeanTSOutputSpec</span><span class="p">(</span><span class="n">TraitedSpec</span><span class="p">):</span>
    
    <span class="n">mean_masked_ts_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&quot;mean ts in .npy (pickle format)&quot;</span><span class="p">)</span>
    

<div class="viewcode-block" id="ExtractMeanTS"><a class="viewcode-back" href="../../../graphpype/correl_mat.html#neuropype_graph.nodes.correl_mat.ExtractMeanTS">[docs]</a><span class="k">class</span> <span class="nc">ExtractMeanTS</span><span class="p">(</span><span class="n">BaseInterface</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract mean time series from a labelled mask in Nifti Format where the voxels of interest have values 1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">input_spec</span> <span class="o">=</span> <span class="n">ExtractMeanTSInputSpec</span>
    <span class="n">output_spec</span> <span class="o">=</span> <span class="n">ExtractMeanTSOutputSpec</span>

    <span class="k">def</span> <span class="nf">_run_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runtime</span><span class="p">):</span>
                
        <span class="k">print</span> <span class="s">&#39;in select_ts_with_mask&#39;</span>
        
        <span class="n">file_4D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">file_4D</span>
        <span class="n">mask_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">mask_file</span>
        <span class="n">filter_mask_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">filter_mask_file</span>
        <span class="n">filter_thr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">filter_thr</span>
        <span class="n">plot_fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">plot_fig</span>
        
        
        <span class="k">if</span> <span class="n">isdefined</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">suffix</span><span class="p">):</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">suffix</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s">&quot;suf&quot;</span>
            
            
        <span class="k">print</span> <span class="s">&quot;loading img data &quot;</span> <span class="o">+</span> <span class="n">file_4D</span>

        <span class="c">### Reading 4D volume file to extract time series</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_4D</span><span class="p">)</span>
        <span class="n">img_data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        
        <span class="k">print</span> <span class="n">img_data</span><span class="o">.</span><span class="n">shape</span>

        
        <span class="c">### Reading 4D volume file to extract time series</span>
        <span class="k">if</span> <span class="n">isdefined</span><span class="p">(</span><span class="n">mask_file</span><span class="p">):</span>
        
            <span class="k">print</span> <span class="s">&quot;loading mask data &quot;</span> <span class="o">+</span> <span class="n">mask_file</span>

            <span class="n">mask_data</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">mask_file</span><span class="p">)</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
            
        <span class="k">elif</span> <span class="n">isdefined</span><span class="p">(</span><span class="n">filter_mask_file</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&quot;loading filter mask data &quot;</span> <span class="o">+</span> <span class="n">filter_mask_file</span>

            <span class="n">filter_mask_data</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filter_mask_file</span><span class="p">)</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
            <span class="n">mask_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span> <span class="o">=</span> <span class="n">filter_mask_data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s">&#39;int&#39;</span><span class="p">)</span>
            
            <span class="n">mask_data</span><span class="p">[</span><span class="n">filter_mask_data</span> <span class="o">&gt;</span> <span class="n">filter_thr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            
        <span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mask_data</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">mask_data</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="k">print</span> <span class="s">&quot;mean_select_mask_data&quot;</span>
        
        <span class="c">### Retaining only time series who are within the mask + non_zero</span>
        <span class="n">mean_masked_ts</span> <span class="o">=</span> <span class="n">mean_select_mask_data</span><span class="p">(</span><span class="n">img_data</span><span class="p">,</span><span class="n">mask_data</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="n">mean_masked_ts</span>
        <span class="k">print</span> <span class="n">mean_masked_ts</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="k">print</span> <span class="s">&quot;saving mean_masked_ts&quot;</span>
        <span class="n">mean_masked_ts_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;mean_&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s">&#39;_ts.txt&#39;</span><span class="p">)</span>    
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">mean_masked_ts_file</span><span class="p">,</span><span class="n">mean_masked_ts</span><span class="p">,</span><span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%.3f</span><span class="s">&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">plot_fig</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                
            <span class="k">print</span> <span class="s">&quot;plotting mean_masked_ts&quot;</span>
            
            <span class="n">plot_mean_masked_ts_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;mean_&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s">&#39;_ts.eps&#39;</span><span class="p">)</span>    
            
            <span class="n">plot_signals</span><span class="p">(</span><span class="n">plot_mean_masked_ts_file</span><span class="p">,</span><span class="n">mean_masked_ts</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">runtime</span>
        
        <span class="c">#return mean_masked_ts_file,subj_coord_rois_file</span>
        
    <span class="k">def</span> <span class="nf">_list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">isdefined</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">suffix</span><span class="p">):</span>
        
            <span class="n">suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">suffix</span>
        
        <span class="k">else</span><span class="p">:</span>
            
            <span class="n">suffix</span> <span class="o">=</span> <span class="s">&quot;suf&quot;</span>
            
        <span class="n">outputs</span><span class="p">[</span><span class="s">&quot;mean_masked_ts_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;mean_&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s">&#39;_ts.txt&#39;</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">outputs</span>
        
        
        
<span class="c">######################################################################################## ConcatTS ##################################################################################################################</span>
</div>
<span class="k">class</span> <span class="nc">ConcatTSInputSpec</span><span class="p">(</span><span class="n">BaseInterfaceInputSpec</span><span class="p">):</span>
    
    <span class="n">all_ts_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;npy file containing all ts to be concatenated&#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
<span class="k">class</span> <span class="nc">ConcatTSOutputSpec</span><span class="p">(</span><span class="n">TraitedSpec</span><span class="p">):</span>
    
    <span class="n">concatenated_ts_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&quot;ts after concatenation&quot;</span><span class="p">)</span>
        

<div class="viewcode-block" id="ConcatTS"><a class="viewcode-back" href="../../../graphpype/correl_mat.html#neuropype_graph.nodes.correl_mat.ConcatTS">[docs]</a><span class="k">class</span> <span class="nc">ConcatTS</span><span class="p">(</span><span class="n">BaseInterface</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Concenate time series &quot;&quot;&quot;</span>

    <span class="n">input_spec</span> <span class="o">=</span> <span class="n">ConcatTSInputSpec</span>
    <span class="n">output_spec</span> <span class="o">=</span> <span class="n">ConcatTSOutputSpec</span>

    <span class="k">def</span> <span class="nf">_run_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runtime</span><span class="p">):</span>
            
        <span class="c">#import os</span>
        <span class="c">#import numpy as np</span>
        <span class="c">#import nibabel as nib</span>
        
        <span class="c">#from neuropype_graph.utils_plot import plot_signals</span>
        
        <span class="n">all_ts_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">all_ts_file</span>
        
        
        <span class="c">## loading ROI coordinates</span>
        <span class="n">all_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">all_ts_file</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="s">&quot;all_ts: &quot;</span> 
        <span class="k">print</span> <span class="n">all_ts</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="n">concatenated_ts</span> <span class="o">=</span> <span class="n">all_ts</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">all_ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="n">concatenated_ts</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="c">### saving time series</span>
        <span class="n">concatenated_ts_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&quot;concatenated_ts.npy&quot;</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">concatenated_ts_file</span><span class="p">,</span><span class="n">concatenated_ts</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">runtime</span>
        
        <span class="c">#return mean_masked_ts_file,subj_coord_rois_file</span>
        
    <span class="k">def</span> <span class="nf">_list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        
        <span class="n">outputs</span><span class="p">[</span><span class="s">&quot;concatenated_ts_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&quot;concatenated_ts.npy&quot;</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">outputs</span>

<span class="c">######################################################################################## MergeTS ##################################################################################################################</span>
</div>
<span class="k">class</span> <span class="nc">MergeTSInputSpec</span><span class="p">(</span><span class="n">BaseInterfaceInputSpec</span><span class="p">):</span>
    
    <span class="n">all_ts_files</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;list of npy files containing all ts to be merged&#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
             
<span class="k">class</span> <span class="nc">MergeTSOutputSpec</span><span class="p">(</span><span class="n">TraitedSpec</span><span class="p">):</span>
    
    <span class="n">merged_ts_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&quot;ts after merge&quot;</span><span class="p">)</span>
        

<div class="viewcode-block" id="MergeTS"><a class="viewcode-back" href="../../../graphpype/correl_mat.html#neuropype_graph.nodes.correl_mat.MergeTS">[docs]</a><span class="k">class</span> <span class="nc">MergeTS</span><span class="p">(</span><span class="n">BaseInterface</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Merges time series from several files &quot;&quot;&quot;</span>

    <span class="n">input_spec</span> <span class="o">=</span> <span class="n">MergeTSInputSpec</span>
    <span class="n">output_spec</span> <span class="o">=</span> <span class="n">MergeTSOutputSpec</span>

    <span class="k">def</span> <span class="nf">_run_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runtime</span><span class="p">):</span>
            
        <span class="n">all_ts_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">all_ts_files</span>
        
        <span class="k">print</span> <span class="n">all_ts_files</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">all_ts_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_ts_files</span><span class="p">):</span>
        
            <span class="n">all_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">all_ts_file</span><span class="p">)</span>
        
            <span class="n">concatenated_ts</span> <span class="o">=</span> <span class="n">all_ts</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">all_ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
            <span class="k">print</span> <span class="n">concatenated_ts</span><span class="o">.</span><span class="n">shape</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">concatenated_ts</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">merged_ts</span> <span class="o">=</span> <span class="n">concatenated_ts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">print</span> <span class="n">merged_ts</span><span class="o">.</span><span class="n">shape</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">merged_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">merged_ts</span><span class="p">,</span><span class="n">concatenated_ts</span><span class="p">),</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">print</span> <span class="n">merged_ts</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">merged_ts_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&quot;merged_ts.npy&quot;</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">merged_ts_file</span><span class="p">,</span><span class="n">merged_ts</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">runtime</span>
        
    <span class="k">def</span> <span class="nf">_list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        
        <span class="n">outputs</span><span class="p">[</span><span class="s">&quot;merged_ts_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&quot;merged_ts.npy&quot;</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">outputs</span>

        
<span class="c">######################################################################################## SeparateTS ##################################################################################################################</span>
</div>
<span class="k">class</span> <span class="nc">SeparateTSInputSpec</span><span class="p">(</span><span class="n">BaseInterfaceInputSpec</span><span class="p">):</span>
    
    <span class="n">all_ts_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;npy file containing all ts to be concatenated&#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
<span class="k">class</span> <span class="nc">SeparateTSOutputSpec</span><span class="p">(</span><span class="n">TraitedSpec</span><span class="p">):</span>
    
    <span class="n">separated_ts_files</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s">&quot;ts files after separation&quot;</span><span class="p">)</span>
    
<div class="viewcode-block" id="SeparateTS"><a class="viewcode-back" href="../../../graphpype/correl_mat.html#neuropype_graph.nodes.correl_mat.SeparateTS">[docs]</a><span class="k">class</span> <span class="nc">SeparateTS</span><span class="p">(</span><span class="n">BaseInterface</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Extract time series from a labelled mask in Nifti Format where all ROIs have the same index&quot;&quot;&quot;</span>

    <span class="n">input_spec</span> <span class="o">=</span> <span class="n">SeparateTSInputSpec</span>
    <span class="n">output_spec</span> <span class="o">=</span> <span class="n">SeparateTSOutputSpec</span>

    <span class="k">def</span> <span class="nf">_run_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runtime</span><span class="p">):</span>
            
        <span class="c">#import os</span>
        <span class="c">#import numpy as np</span>
        <span class="c">#import nibabel as nib</span>
        
        <span class="c">#from neuropype_graph.utils_plot import plot_signals</span>
        
        <span class="n">all_ts_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">all_ts_file</span>
        
        <span class="n">path</span><span class="p">,</span><span class="n">fname_ts</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="n">split_f</span><span class="p">(</span><span class="n">all_ts_file</span><span class="p">)</span>
        
        <span class="c">### loading ts shape = (trigs, electrods, time points)</span>
        
        <span class="n">all_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">all_ts_file</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="s">&quot;all_ts: &quot;</span> 
        <span class="k">print</span> <span class="n">all_ts</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="n">separated_ts_files</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">all_ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            
            
            <span class="n">sep_ts_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">fname_ts</span> <span class="o">+</span> <span class="s">&#39;_trig_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;.npy&#39;</span><span class="p">)</span>
            
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">sep_ts_file</span><span class="p">,</span><span class="n">all_ts</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:])</span>
            
            <span class="n">separated_ts_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sep_ts_file</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">separated_ts_files</span> <span class="o">=</span> <span class="n">separated_ts_files</span>
        
        <span class="k">return</span> <span class="n">runtime</span>
        
        <span class="c">#return mean_masked_ts_file,subj_coord_rois_file</span>
        
    <span class="k">def</span> <span class="nf">_list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        
        <span class="n">outputs</span><span class="p">[</span><span class="s">&quot;separated_ts_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separated_ts_files</span>
        
        <span class="k">return</span> <span class="n">outputs</span>

<span class="c">################################################################################# RegressCovar ######################################################################################################################</span>
 

<span class="c">#from neuropype_graph.utils_cor import regress_movement_wm_csf_parameters</span></div>
<span class="kn">from</span> <span class="nn">neuropype_graph.utils_cor</span> <span class="kn">import</span> <span class="n">regress_parameters</span><span class="p">,</span><span class="n">regress_filter_normalize_parameters</span>

<span class="k">class</span> <span class="nc">RegressCovarInputSpec</span><span class="p">(</span><span class="n">BaseInterfaceInputSpec</span><span class="p">):</span>
    <span class="n">masked_ts_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;time series in npy format&#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="n">rp_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Movement parameters&#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="n">mean_wm_ts_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;White matter signal&#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    
    <span class="n">mean_csf_ts_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Cerebro-spinal fluid (ventricules) signal&#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    
    <span class="n">filtered</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">usedefault</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Is the signal filtered after regression?&quot;</span><span class="p">)</span>
    
    <span class="n">normalized</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">usedefault</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Is the signal normalized after regression?&quot;</span><span class="p">)</span>
    
<span class="k">class</span> <span class="nc">RegressCovarOutputSpec</span><span class="p">(</span><span class="n">TraitedSpec</span><span class="p">):</span>
    
    <span class="n">resid_ts_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&quot;residuals of time series after regression of all paramters&quot;</span><span class="p">)</span>
    
<span class="k">class</span> <span class="nc">RegressCovar</span><span class="p">(</span><span class="n">BaseInterface</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Regress parameters of non-interest (i.e. movement parameters, white matter, csf) from signal</span>
<span class="sd">    Optionnally filter and normalize (z-score) the residuals</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">input_spec</span> <span class="o">=</span> <span class="n">RegressCovarInputSpec</span>
    <span class="n">output_spec</span> <span class="o">=</span> <span class="n">RegressCovarOutputSpec</span>

    <span class="k">def</span> <span class="nf">_run_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runtime</span><span class="p">):</span>
                    
                    
        <span class="k">print</span> <span class="s">&quot;in regress_covariates&quot;</span>
        
        <span class="n">masked_ts_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">masked_ts_file</span>
        <span class="n">rp_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">rp_file</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">filtered</span>
        <span class="n">normalized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">normalized</span>
        
        <span class="k">print</span> <span class="s">&quot;load masked_ts_file&quot;</span>
        
        <span class="n">data_mask_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">masked_ts_file</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="n">data_mask_matrix</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">print</span> <span class="s">&quot;load rp parameters&quot;</span>
        
        <span class="k">print</span> <span class="n">rp_file</span>
        
        <span class="n">rp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">rp_file</span><span class="p">)</span>
        <span class="c">#rp = np.loadtxt(rp_file,dtype = np.float)</span>
        
        <span class="k">print</span> <span class="n">rp</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="k">if</span> <span class="n">isdefined</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">mean_csf_ts_file</span><span class="p">):</span>
            
            <span class="n">mean_csf_ts_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">mean_csf_ts_file</span>
            
            <span class="k">print</span> <span class="s">&quot;load mean_csf_ts_file&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mean_csf_ts_file</span><span class="p">)</span>
            
            <span class="n">mean_csf_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">mean_csf_ts_file</span><span class="p">)</span>
            
            <span class="k">print</span> <span class="n">mean_csf_ts</span><span class="o">.</span><span class="n">shape</span>
            
            <span class="c">#rp = np.concatenate((rp,mean_csf_ts),axis = 1)</span>
            <span class="n">rp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">rp</span><span class="p">,</span><span class="n">mean_csf_ts</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mean_csf_ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)),</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            
            <span class="k">print</span> <span class="n">rp</span><span class="o">.</span><span class="n">shape</span>
            
            
        <span class="k">if</span> <span class="n">isdefined</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">mean_wm_ts_file</span><span class="p">):</span>
            
            <span class="n">mean_wm_ts_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">mean_wm_ts_file</span>
            
            <span class="k">print</span> <span class="s">&quot;load mean_wm_ts_file&quot;</span>
            
            <span class="n">mean_wm_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">mean_wm_ts_file</span><span class="p">)</span>
            
            
            <span class="c">#rp = np.concatenate((rp,mean_csf_ts),axis = 1)</span>
            <span class="n">rp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">rp</span><span class="p">,</span><span class="n">mean_wm_ts</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mean_wm_ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)),</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            
            <span class="k">print</span> <span class="n">rp</span><span class="o">.</span><span class="n">shape</span>
            
        
        <span class="k">if</span> <span class="n">filtered</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">normalized</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            
            <span class="c">### regression movement parameters and computing z-score on the residuals</span>
            <span class="c">#resid_data_matrix = regress_movement_wm_csf_parameters(data_mask_matrix,rp,mean_wm_ts,mean_csf_ts)</span>
            <span class="n">resid_data_matrix</span><span class="p">,</span><span class="n">resid_filt_data_matrix</span><span class="p">,</span><span class="n">z_score_data_matrix</span> <span class="o">=</span> <span class="n">regress_filter_normalize_parameters</span><span class="p">(</span><span class="n">data_mask_matrix</span><span class="p">,</span><span class="n">rp</span><span class="p">)</span>
            
            <span class="k">print</span> <span class="n">resid_data_matrix</span><span class="o">.</span><span class="n">shape</span>

            <span class="k">print</span> <span class="s">&quot;saving resid_ts&quot;</span>
            
            <span class="n">resid_ts_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;resid_ts.npy&#39;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">resid_ts_file</span><span class="p">,</span><span class="n">z_score_data_matrix</span> <span class="p">)</span>

            <span class="k">print</span> <span class="s">&quot;plotting resid_ts&quot;</span>
            
            <span class="n">plot_resid_ts_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;resid_ts.eps&#39;</span><span class="p">)</span>
            
            <span class="n">plot_sep_signals</span><span class="p">(</span><span class="n">plot_resid_ts_file</span><span class="p">,</span><span class="n">z_score_data_matrix</span><span class="p">)</span>
            
            
            <span class="k">print</span> <span class="s">&quot;plotting diff filtered and non filtered data&quot;</span>
            
            <span class="n">plot_diff_filt_ts_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;diff_filt_ts.eps&#39;</span><span class="p">)</span>
            
            <span class="n">plot_signals</span><span class="p">(</span><span class="n">plot_diff_filt_ts_file</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">resid_filt_data_matrix</span> <span class="o">-</span> <span class="n">resid_data_matrix</span><span class="p">,</span><span class="n">dtype</span> <span class="o">=</span> <span class="s">&#39;float&#39;</span><span class="p">))</span>
            
        <span class="k">elif</span> <span class="n">filtered</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">normalized</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            
            <span class="k">print</span> <span class="s">&quot;Using only regression&quot;</span>
        
            <span class="c">### regression movement parameters and computing z-score on the residuals</span>
            <span class="c">#resid_data_matrix = regress_movement_wm_csf_parameters(data_mask_matrix,rp,mean_wm_ts,mean_csf_ts)</span>
            <span class="n">resid_data_matrix</span> <span class="o">=</span> <span class="n">regress_parameters</span><span class="p">(</span><span class="n">data_mask_matrix</span><span class="p">,</span><span class="n">rp</span><span class="p">)</span>
            
            <span class="k">print</span> <span class="n">resid_data_matrix</span><span class="o">.</span><span class="n">shape</span>

            <span class="k">print</span> <span class="s">&quot;saving resid_ts&quot;</span>
            
            <span class="n">resid_ts_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;resid_ts.npy&#39;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">resid_ts_file</span><span class="p">,</span><span class="n">resid_data_matrix</span> <span class="p">)</span>

            
            <span class="n">resid_ts_txt_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;resid_ts.txt&#39;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">resid_ts_txt_file</span><span class="p">,</span><span class="n">resid_data_matrix</span><span class="p">,</span><span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%0.3f</span><span class="s">&#39;</span><span class="p">)</span>

            
            <span class="k">print</span> <span class="s">&quot;plotting resid_ts&quot;</span>
            
            <span class="n">plot_resid_ts_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;resid_ts.eps&#39;</span><span class="p">)</span>
            
            <span class="n">plot_sep_signals</span><span class="p">(</span><span class="n">plot_resid_ts_file</span><span class="p">,</span><span class="n">resid_data_matrix</span><span class="p">)</span>
            
            
            <span class="c">#print &quot;plotting diff filtered and non filtered data&quot;</span>
            
            <span class="c">#plot_diff_filt_ts_file = os.path.abspath(&#39;diff_filt_ts.eps&#39;)</span>
            
            <span class="c">#plot_signals(plot_diff_filt_ts_file,np.array(resid_filt_data_matrix - resid_data_matrix,dtype = &#39;float&#39;))</span>
            
        <span class="k">else</span><span class="p">:</span>
            
            <span class="k">print</span> <span class="s">&quot;Warning, not implemented (RegressCovar)&quot;</span>
            
        <span class="k">return</span> <span class="n">runtime</span>
        
        
    <span class="k">def</span> <span class="nf">_list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        
        <span class="n">outputs</span><span class="p">[</span><span class="s">&quot;resid_ts_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;resid_ts.npy&#39;</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">outputs</span>

        <span class="c">################################################################################# FindSPMRegressor ######################################################################################################################</span>
 

<span class="k">class</span> <span class="nc">FindSPMRegressorInputSpec</span><span class="p">(</span><span class="n">BaseInterfaceInputSpec</span><span class="p">):</span>
    
    <span class="n">spm_mat_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;SPM design matrix after generate model&#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="n">regressor_name</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Name of the regressor in SPM design matrix to be looked after&#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="n">run_index</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">usedefault</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Run (session) index, default is one in SPM&quot;</span><span class="p">)</span>
     
    <span class="n">only_positive_values</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">usedefault</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Return only positive values of the regressor (negative values are set to 0)&quot;</span><span class="p">)</span>
    
    <span class="c">#concatenate_runs = traits.Int(1, usedefault = True , desc = &quot;If concatenate runs, how many runs there is (needed to return the part of the regressors that is active for the session only)&quot;)</span>
    <span class="n">concatenated_runs</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="n">usedefault</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;If concatenate runs, need to search for the lenghth of the session&quot;</span><span class="p">)</span>
    
<span class="k">class</span> <span class="nc">FindSPMRegressorOutputSpec</span><span class="p">(</span><span class="n">TraitedSpec</span><span class="p">):</span>
    
    <span class="n">regressor_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&quot;txt file containing the regressor&quot;</span><span class="p">)</span>
    
<div class="viewcode-block" id="FindSPMRegressor"><a class="viewcode-back" href="../../../graphpype/correl_mat.html#neuropype_graph.nodes.correl_mat.FindSPMRegressor">[docs]</a><span class="k">class</span> <span class="nc">FindSPMRegressor</span><span class="p">(</span><span class="n">BaseInterface</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Regress parameters of non-interest (i.e. movement parameters, white matter, csf) from signal</span>
<span class="sd">    Optionnally filter and normalize (z-score) the residuals</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">input_spec</span> <span class="o">=</span> <span class="n">FindSPMRegressorInputSpec</span>
    <span class="n">output_spec</span> <span class="o">=</span> <span class="n">FindSPMRegressorOutputSpec</span>

    <span class="k">def</span> <span class="nf">_run_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runtime</span><span class="p">):</span>
                   
                   
                    
        <span class="kn">import</span> <span class="nn">scipy.io</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="n">spm_mat_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">spm_mat_file</span>
        <span class="n">regressor_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">regressor_name</span>
        <span class="n">run_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">run_index</span>
        <span class="n">only_positive_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">only_positive_values</span>
        <span class="n">concatenated_runs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">concatenated_runs</span>
        
        
        <span class="k">print</span> <span class="n">spm_mat_file</span>
        
        <span class="c">##Reading spm.mat for regressors extraction:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">spm_mat_file</span><span class="p">)</span>
        
        <span class="c">#print d</span>
        
        
        <span class="c">##Choosing the column according to the regressor name</span>
        <span class="c">#_,col = np.where(d[&#39;SPM&#39;][&#39;xX&#39;][0][0][&#39;name&#39;][0][0] == u&#39;Sn(1) &#39; + regressor_name)</span>
        
        <span class="n">cond_name</span> <span class="o">=</span> <span class="s">u&#39;Sn(&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">run_index</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;) &#39;</span> <span class="o">+</span> <span class="n">regressor_name</span> <span class="o">+</span> <span class="s">&#39;*bf(1)&#39;</span>
        
        <span class="k">print</span> <span class="n">cond_name</span>
        
        <span class="n">_</span><span class="p">,</span><span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;SPM&#39;</span><span class="p">][</span><span class="s">&#39;xX&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">cond_name</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="n">col</span>
        
        <span class="c">## reformating matrix (1,len) in vector (len)</span>
        <span class="n">regressor_vect</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;SPM&#39;</span><span class="p">][</span><span class="s">&#39;xX&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;X&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][:,</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        

        <span class="k">print</span> <span class="n">regressor_vect</span>
        
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">regressor_vect</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Error, empty regressor {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cond_name</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">only_positive_values</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            
            <span class="n">regressor_vect</span><span class="p">[</span><span class="n">regressor_vect</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">if</span> <span class="n">concatenated_runs</span><span class="p">:</span>
            
            <span class="k">print</span> <span class="n">run_index</span>
            <span class="k">print</span> <span class="n">regressor_vect</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
            
            <span class="n">samples</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;SPM&#39;</span><span class="p">][</span><span class="s">&#39;xX&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;K&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;row&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">run_index</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
            
            <span class="k">print</span> <span class="n">samples</span>
            
            <span class="n">regressor_vect</span> <span class="o">=</span> <span class="n">regressor_vect</span><span class="p">[</span><span class="n">samples</span><span class="p">]</span>
            
            <span class="k">print</span> <span class="n">regressor_vect</span>
            
            <span class="k">print</span> <span class="n">regressor_vect</span><span class="o">.</span><span class="n">shape</span>
            
            
        <span class="k">print</span> <span class="s">&quot;Saving extract_cond&quot;</span>
        <span class="n">regressor_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;extract_cond.txt&#39;</span><span class="p">)</span>

        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">regressor_file</span><span class="p">,</span><span class="n">regressor_vect</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">runtime</span>
        
        
    <span class="k">def</span> <span class="nf">_list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        
        <span class="n">outputs</span><span class="p">[</span><span class="s">&quot;regressor_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;extract_cond.txt&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">outputs</span>

        
        <span class="c">################################################################################# MergeRuns ######################################################################################################################</span>
 
</div>
<span class="k">class</span> <span class="nc">MergeRunsInputSpec</span><span class="p">(</span><span class="n">BaseInterfaceInputSpec</span><span class="p">):</span>
    
    <span class="n">ts_files</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Numpy files with time series from different runs (sessions)&#39;</span><span class="p">,</span><span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">regressor_files</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Txt files with regressors from different runs (sessions)&#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="n">coord_rois_files</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Txt files with coords from different runs (sessions)&#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
<span class="k">class</span> <span class="nc">MergeRunsOutputSpec</span><span class="p">(</span><span class="n">TraitedSpec</span><span class="p">):</span>
    
    <span class="n">ts_all_runs_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&quot;npy file containing the merge ts&quot;</span><span class="p">)</span>
    
    <span class="n">regressor_all_runs_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&quot;txt file containing the merged regressors&quot;</span><span class="p">)</span>
    
    <span class="n">coord_rois_all_runs_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&quot;txt file containing the merged coords&quot;</span><span class="p">)</span>
    
<span class="k">class</span> <span class="nc">MergeRuns</span><span class="p">(</span><span class="n">BaseInterface</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description:</span>
<span class="sd">    </span>
<span class="sd">    Merge time series,regressor files and coord files</span>
<span class="sd">    Could be done with different cases</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">input_spec</span> <span class="o">=</span> <span class="n">MergeRunsInputSpec</span>
    <span class="n">output_spec</span> <span class="o">=</span> <span class="n">MergeRunsOutputSpec</span>

    <span class="k">def</span> <span class="nf">_run_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runtime</span><span class="p">):</span>
                   
        <span class="k">print</span> <span class="s">&#39;in merge_runs&#39;</span>
        
        <span class="n">ts_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">ts_files</span>
        <span class="n">regressor_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">regressor_files</span>
        <span class="n">coord_rois_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">coord_rois_files</span>
        
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts_files</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">regressor_files</span><span class="p">):</span>
            
            <span class="k">print</span> <span class="s">&quot;Warning, time series and regressors have different length (!= number of runs)&quot;</span>
            <span class="k">return</span> <span class="mi">0</span>
            
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts_files</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord_rois_files</span><span class="p">):</span>
            
            <span class="k">print</span> <span class="s">&quot;Warning, time series and number of coordinates have different length (!= number of runs)&quot;</span>
            <span class="k">return</span> <span class="mi">0</span>
            
        <span class="c">### concatenate time series</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ts_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ts_files</span><span class="p">):</span>
            
            <span class="n">data_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ts_file</span><span class="p">)</span>
            
            <span class="k">print</span> <span class="n">data_matrix</span><span class="o">.</span><span class="n">shape</span>
            
            <span class="c">## loading ROI coordinates</span>
            <span class="n">coord_rois</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">coord_rois_files</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            
            <span class="k">print</span> <span class="n">coord_rois</span><span class="o">.</span><span class="n">shape</span>
            
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">data_matrix_all_runs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">data_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">),</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">data_matrix</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                
                <span class="n">coord_rois_all_runs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coord_rois</span><span class="p">,</span><span class="n">dtype</span> <span class="o">=</span> <span class="s">&#39;float&#39;</span><span class="p">)</span>
                
                
            <span class="k">if</span> <span class="n">coord_rois_all_runs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">coord_rois</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                
                <span class="k">print</span> <span class="s">&quot;ROIs do not match for all different sessions &quot;</span>
                
                <span class="k">print</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
                
                <span class="k">print</span> <span class="s">&quot;Warning, not implemented yet.... &quot;</span>
                
                <span class="c">### pris de http://stackoverflow.com/questions/8317022/get-intersecting-rows-across-two-2d-numpy-arrays</span>
                <span class="c">###  tester....</span>
                <span class="c">### finir galement la partie avec data_matrix_all_runs, en supprimant les colonnes qui ne sont pas communes  tous les runs...</span>
                
                <span class="mi">0</span><span class="o">/</span><span class="mi">0</span>
                
                <span class="n">A</span> <span class="o">=</span> <span class="n">coord_rois_all_runs</span>
                <span class="n">B</span> <span class="o">=</span> <span class="n">coord_rois</span>
                
                <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;names&#39;</span><span class="p">:[</span><span class="s">&#39;f{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">)],</span>
                    <span class="s">&#39;formats&#39;</span><span class="p">:</span><span class="n">ncols</span> <span class="o">*</span> <span class="p">[</span><span class="n">A</span><span class="o">.</span><span class="n">dtype</span><span class="p">]}</span>

                <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="p">),</span> <span class="n">B</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>

                <span class="c"># This last bit is optional if you&#39;re okay with &quot;C&quot; being a structured array...</span>
                <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>

                <span class="n">coord_rois_all_runs</span> <span class="o">=</span> <span class="n">C</span>

            <span class="n">data_matrix_all_runs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data_matrix_all_runs</span><span class="p">,</span><span class="n">data_matrix</span><span class="p">),</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            
            <span class="k">print</span> <span class="n">data_matrix_all_runs</span><span class="o">.</span><span class="n">shape</span>
            
        <span class="c">### save times series for all runs</span>
        <span class="n">ts_all_runs_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;ts_all_runs.npy&#39;</span><span class="p">)</span>
        
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">ts_all_runs_file</span><span class="p">,</span><span class="n">data_matrix_all_runs</span><span class="p">)</span>
        
        <span class="c">### save coords in common for all runs</span>
        <span class="n">coord_rois_all_runs_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;coord_rois_all_runs.txt&#39;</span><span class="p">)</span>
        
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">coord_rois_all_runs_file</span><span class="p">,</span><span class="n">coord_rois_all_runs</span><span class="p">,</span> <span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%2.3f</span><span class="s">&#39;</span><span class="p">)</span>
        
        <span class="c">### compute regressor for all sessions together (need to sum)</span>
        
        <span class="k">print</span> <span class="s">&quot;compute regressor for all sessions together (need to sum)&quot;</span>
        
        <span class="n">regressor_all_runs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span><span class="p">)</span>
        
        <span class="c">### Sum regressors</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">regress_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">regressor_files</span><span class="p">):</span>
            
            <span class="n">regress_data_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">regress_file</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">regress_data_vector</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                
                <span class="k">if</span> <span class="n">regressor_all_runs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    
                    <span class="n">regressor_all_runs</span> <span class="o">=</span> <span class="n">regress_data_vector</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">regressor_all_runs</span> <span class="o">=</span> <span class="n">regressor_all_runs</span> <span class="o">+</span> <span class="n">regress_data_vector</span>
                
            <span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">regressor_all_runs</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span>
        
        <span class="n">regressor_all_runs_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;regressor_all_runs.txt&#39;</span><span class="p">)</span>

        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">regressor_all_runs_file</span><span class="p">,</span><span class="n">regressor_all_runs</span><span class="p">,</span><span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%0.3f</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">runtime</span>
        
    <span class="k">def</span> <span class="nf">_list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        
        <span class="k">print</span> <span class="n">outputs</span>
        
        <span class="n">outputs</span><span class="p">[</span><span class="s">&quot;ts_all_runs_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;ts_all_runs.npy&#39;</span><span class="p">)</span>
        
        <span class="n">outputs</span><span class="p">[</span><span class="s">&quot;coord_rois_all_runs_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;coord_rois_all_runs.txt&#39;</span><span class="p">)</span>
        
        <span class="n">outputs</span><span class="p">[</span><span class="s">&quot;regressor_all_runs_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;regressor_all_runs.txt&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outputs</span>

        <span class="c">################################################################################# ComputeConfCorMat ######################################################################################################################</span>
 
<span class="kn">from</span> <span class="nn">neuropype_graph.utils_cor</span> <span class="kn">import</span> <span class="n">return_conf_cor_mat</span>

<span class="kn">from</span> <span class="nn">neuropype_graph.utils_plot</span> <span class="kn">import</span> <span class="n">plot_hist</span><span class="p">,</span><span class="n">plot_cormat</span><span class="p">,</span><span class="n">plot_ranged_cormat</span>
        
<span class="k">class</span> <span class="nc">ComputeConfCorMatInputSpec</span><span class="p">(</span><span class="n">BaseInterfaceInputSpec</span><span class="p">):</span>
    
    <span class="n">ts_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Numpy files with time series to be correlated&#39;</span><span class="p">,</span><span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">transpose_ts</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span><span class="n">usedefault</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span><span class="n">desc</span> <span class="o">=</span>  <span class="s">&#39;whether to transpose timeseries&#39;</span><span class="p">,</span> <span class="n">mandatory</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
                              
    <span class="n">weight_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Weight of the correlation (normally, condition regressor file)&#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    
    <span class="n">conf_interval_prob</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">usedefault</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Confidence interval&#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="n">plot_mat</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">usedefault</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Confidence interval&#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    
    <span class="n">labels_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Name of the nodes (used only if plot = true)&#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    
<span class="k">class</span> <span class="nc">ComputeConfCorMatOutputSpec</span><span class="p">(</span><span class="n">TraitedSpec</span><span class="p">):</span>
    
    <span class="n">cor_mat_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&quot;npy file containing the R values of correlation&quot;</span><span class="p">)</span>
    
    <span class="n">Z_cor_mat_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&quot;npy file containing the Z-values (after Fisher&#39;s R-to-Z trasformation) of correlation&quot;</span><span class="p">)</span>
    
    <span class="n">conf_cor_mat_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&quot;npy file containing the confidence interval around R values&quot;</span><span class="p">)</span>
    
    <span class="c">#Z_conf_cor_mat_file = File(exists=True, desc=&quot;npy file containing the Z-values (after Fisher&#39;s R-to-Z trasformation) of correlation&quot;)</span>
    
<div class="viewcode-block" id="ComputeConfCorMat"><a class="viewcode-back" href="../../../graphpype/correl_mat.html#neuropype_graph.nodes.correl_mat.ComputeConfCorMat">[docs]</a><span class="k">class</span> <span class="nc">ComputeConfCorMat</span><span class="p">(</span><span class="n">BaseInterface</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    </span>
<span class="sd">    Description:</span>
<span class="sd">    </span>
<span class="sd">    Compute correlation between time series, with a given confidence interval. If weight_file is specified, used for weighted correlation</span>
<span class="sd">    </span>
<span class="sd">    Inputs:</span>
<span class="sd">        </span>
<span class="sd">        ts_file:</span>
<span class="sd">            type = File, exists=True, desc=&#39;Numpy files with time series to be correlated&#39;,mandatory=True</span>

<span class="sd">        transpose_ts:</span>
<span class="sd">            type = Bool, default=True,usedefault = True,desc =  &#39;whether to transpose timeseries&#39;, mandatory = True</span>
<span class="sd">                                </span>
<span class="sd">        weight_file:</span>
<span class="sd">            type = File, exists=True, desc=&#39;Weight of the correlation (normally, condition regressor file)&#39;, mandatory=False</span>
<span class="sd">        </span>
<span class="sd">        conf_interval_prob:</span>
<span class="sd">            type = Float, default = 0.05, usedefault = True, desc=&#39;Confidence interval&#39;, mandatory=True</span>
<span class="sd">        </span>
<span class="sd">        plot_mat:</span>
<span class="sd">            type = Bool, default = True, usedefault = True, desc=&#39;Confidence interval&#39;, mandatory=False</span>
<span class="sd">        </span>
<span class="sd">        labels_file:</span>
<span class="sd">            type = File, exists=True, desc=&#39;Name of the nodes (used only if plot = true)&#39;, mandatory=False</span>
<span class="sd">        </span>
<span class="sd">    Outputs:</span>
<span class="sd">        </span>
<span class="sd">        cor_mat_file:</span>
<span class="sd">            type = File, exists=True, desc=&quot;npy file containing the R values of correlation&quot;</span>
<span class="sd">        </span>
<span class="sd">        Z_cor_mat_file:</span>
<span class="sd">            type = File, exists=True, desc=&quot;npy file containing the Z-values (after Fisher&#39;s R-to-Z trasformation) of correlation&quot;</span>
<span class="sd">        </span>
<span class="sd">        conf_cor_mat_file:</span>
<span class="sd">            type = File, exists=True, desc=&quot;npy file containing the confidence interval around R values&quot;</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    
    <span class="n">input_spec</span> <span class="o">=</span> <span class="n">ComputeConfCorMatInputSpec</span>
    <span class="n">output_spec</span> <span class="o">=</span> <span class="n">ComputeConfCorMatOutputSpec</span>

    <span class="k">def</span> <span class="nf">_run_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runtime</span><span class="p">):</span>
                   
                  
        <span class="k">print</span> <span class="s">&#39;in compute_conf_correlation_matrix&#39;</span>
        
        <span class="n">ts_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">ts_file</span>
        <span class="n">weight_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">weight_file</span>
        <span class="n">transpose_ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">transpose_ts</span>
        <span class="n">conf_interval_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">conf_interval_prob</span>
            
        <span class="n">plot_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">plot_mat</span>
        <span class="n">labels_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">labels_file</span>
        
        <span class="k">print</span> <span class="s">&#39;load resid data&#39;</span>
        
        <span class="n">path</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">split_f</span><span class="p">(</span><span class="n">ts_file</span><span class="p">)</span>
        
        <span class="n">data_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ts_file</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="n">data_matrix</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="k">if</span> <span class="n">transpose_ts</span><span class="p">:</span>
            <span class="n">data_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data_matrix</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">data_matrix</span><span class="o">.</span><span class="n">shape</span>
        
        
        <span class="k">if</span> <span class="n">isdefined</span><span class="p">(</span><span class="n">weight_file</span><span class="p">):</span>
        
            <span class="k">print</span> <span class="s">&#39;load weight_vect&#39;</span>
        
            <span class="n">weight_vect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">weight_file</span><span class="p">)</span>
            
            <span class="k">print</span> <span class="n">weight_vect</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weight_vect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        
        <span class="k">print</span> <span class="s">&quot;compute return_Z_cor_mat&quot;</span>
        
        <span class="n">cor_mat</span><span class="p">,</span><span class="n">Z_cor_mat</span><span class="p">,</span><span class="n">conf_cor_mat</span><span class="p">,</span><span class="n">Z_conf_cor_mat</span> <span class="o">=</span> <span class="n">return_conf_cor_mat</span><span class="p">(</span><span class="n">data_matrix</span><span class="p">,</span><span class="n">weight_vect</span><span class="p">,</span><span class="n">conf_interval_prob</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="n">Z_cor_mat</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="n">cor_mat</span> <span class="o">=</span> <span class="n">cor_mat</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">cor_mat</span><span class="p">)</span>
        
        
        <span class="n">Z_cor_mat</span> <span class="o">=</span> <span class="n">Z_cor_mat</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Z_cor_mat</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="s">&quot;saving cor_mat as npy&quot;</span>
        
        <span class="n">cor_mat_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;cor_mat_&#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s">&#39;.npy&#39;</span><span class="p">)</span>
        
        <span class="c">#np.save(cor_mat_file,non_nan_cor_mat)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">cor_mat_file</span><span class="p">,</span><span class="n">cor_mat</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="s">&quot;saving conf_cor_mat as npy&quot;</span>
        
        <span class="n">conf_cor_mat_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;conf_cor_mat_&#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s">&#39;.npy&#39;</span><span class="p">)</span>
        
        <span class="c">#np.save(conf_cor_mat_file,non_nan_conf_cor_mat)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">conf_cor_mat_file</span><span class="p">,</span><span class="n">conf_cor_mat</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="s">&quot;saving Z_cor_mat as npy&quot;</span>
        
        <span class="n">Z_cor_mat_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;Z_cor_mat_&#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s">&#39;.npy&#39;</span><span class="p">)</span>
        
        <span class="c">#np.save(Z_cor_mat_file,non_nan_Z_cor_mat)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">Z_cor_mat_file</span><span class="p">,</span><span class="n">Z_cor_mat</span><span class="p">)</span>
        
        
        <span class="c">#print &quot;saving Z_conf_cor_mat as npy&quot;</span>
        
        <span class="c">#Z_conf_cor_mat_file = os.path.abspath(&#39;Z_conf_cor_mat_&#39; + fname + &#39;.npy&#39;)</span>
        
        <span class="c">#np.save(Z_conf_cor_mat_file,Z_conf_cor_mat)</span>
        
        
        <span class="k">if</span> <span class="n">plot_mat</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">isdefined</span><span class="p">(</span><span class="n">labels_file</span><span class="p">):</span>
                    
                <span class="k">print</span> <span class="s">&#39;extracting node labels&#39;</span>
                    
                <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">labels_file</span><span class="p">)]</span>
                <span class="k">print</span> <span class="n">labels</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="c">############# cor_mat</span>
            
            <span class="c">#### heatmap </span>
            
            <span class="k">print</span> <span class="s">&#39;plotting cor_mat heatmap&#39;</span>
            
            <span class="n">plot_heatmap_cor_mat_file</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;heatmap_cor_mat_&#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s">&#39;.eps&#39;</span><span class="p">)</span>
            
            <span class="n">plot_cormat</span><span class="p">(</span><span class="n">plot_heatmap_cor_mat_file</span><span class="p">,</span><span class="n">cor_mat</span><span class="p">,</span><span class="n">list_labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">)</span>
            
            
            
            <span class="c">#### histogram </span>
            
            <span class="k">print</span> <span class="s">&#39;plotting cor_mat histogram&#39;</span>
            
            <span class="n">plot_hist_cor_mat_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;hist_cor_mat_&#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s">&#39;.eps&#39;</span><span class="p">)</span>
            
            <span class="n">plot_hist</span><span class="p">(</span><span class="n">plot_hist_cor_mat_file</span><span class="p">,</span><span class="n">cor_mat</span><span class="p">,</span><span class="n">nb_bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
            
            <span class="c">############ Z_cor_mat</span>
            
            <span class="n">Z_cor_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">Z_cor_mat_file</span><span class="p">)</span>
            
            <span class="c">#### heatmap </span>
            
            <span class="k">print</span> <span class="s">&#39;plotting Z_cor_mat heatmap&#39;</span>
            
            <span class="n">plot_heatmap_Z_cor_mat_file</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;heatmap_Z_cor_mat_&#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s">&#39;.eps&#39;</span><span class="p">)</span>
            
            <span class="n">plot_cormat</span><span class="p">(</span><span class="n">plot_heatmap_Z_cor_mat_file</span><span class="p">,</span><span class="n">Z_cor_mat</span><span class="p">,</span><span class="n">list_labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">)</span>
            
            <span class="c">#### heatmap </span>
            
            <span class="k">print</span> <span class="s">&#39;plotting cor_mat heatmap&#39;</span>
            
            <span class="n">plot_heatmap_ranged_Z_cor_mat_file</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;heatmap_ranged_cor_mat_&#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s">&#39;.eps&#39;</span><span class="p">)</span>
            
            <span class="n">plot_ranged_cormat</span><span class="p">(</span><span class="n">plot_heatmap_ranged_Z_cor_mat_file</span><span class="p">,</span><span class="n">Z_cor_mat</span><span class="p">,</span><span class="n">fix_full_range</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">3.5</span><span class="p">],</span><span class="n">list_labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">)</span>
            
            <span class="c">#### histogram </span>
            
            <span class="k">print</span> <span class="s">&#39;plotting Z_cor_mat histogram&#39;</span>
            
            <span class="n">plot_hist_Z_cor_mat_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;hist_Z_cor_mat_&#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s">&#39;.eps&#39;</span><span class="p">)</span>
            
            <span class="n">plot_hist</span><span class="p">(</span><span class="n">plot_hist_Z_cor_mat_file</span><span class="p">,</span><span class="n">Z_cor_mat</span><span class="p">,</span><span class="n">nb_bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
            
            <span class="c">############ conf_cor_mat</span>
            
            <span class="c">#### heatmap </span>
            
            <span class="k">print</span> <span class="s">&#39;plotting conf_cor_mat heatmap&#39;</span>
            
            <span class="n">plot_heatmap_conf_cor_mat_file</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;heatmap_conf_cor_mat_&#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s">&#39;.eps&#39;</span><span class="p">)</span>
            
            <span class="n">plot_cormat</span><span class="p">(</span><span class="n">plot_heatmap_conf_cor_mat_file</span><span class="p">,</span><span class="n">conf_cor_mat</span><span class="p">,</span><span class="n">list_labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">)</span>
            
            <span class="c">#### histogram </span>
            
            <span class="k">print</span> <span class="s">&#39;plotting conf_cor_mat histogram&#39;</span>
            
            <span class="n">plot_hist_conf_cor_mat_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;hist_conf_cor_mat_&#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s">&#39;.eps&#39;</span><span class="p">)</span>

            <span class="n">plot_hist</span><span class="p">(</span><span class="n">plot_hist_conf_cor_mat_file</span><span class="p">,</span><span class="n">conf_cor_mat</span><span class="p">,</span><span class="n">nb_bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
            
        
            <span class="c">############# Z_conf_cor_mat</span>
            
            <span class="c">#Z_conf_cor_mat = np.load(Z_conf_cor_mat_file)</span>
            
            <span class="c">##### heatmap </span>
            
            <span class="c">#print &#39;plotting Z_conf_cor_mat heatmap&#39;</span>
            
            <span class="c">#plot_heatmap_Z_conf_cor_mat_file =  os.path.abspath(&#39;heatmap_Z_conf_cor_mat_&#39; + fname + &#39;.eps&#39;)</span>
            
            <span class="c">#plot_cormat(plot_heatmap_Z_conf_cor_mat_file,Z_conf_cor_mat,list_labels = labels)</span>
            
            <span class="c">##### histogram </span>
            
            <span class="c">#print &#39;plotting Z_conf_cor_mat histogram&#39;</span>
            
            <span class="c">#plot_hist_Z_conf_cor_mat_file = os.path.abspath(&#39;hist_Z_conf_cor_mat_&#39; + fname + &#39;.eps&#39;)</span>
            
            <span class="c">#plot_hist(plot_hist_Z_conf_cor_mat_file,Z_conf_cor_mat,nb_bins = 100)</span>
            
        
        <span class="k">return</span> <span class="n">runtime</span>
        
    <span class="k">def</span> <span class="nf">_list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        
        <span class="n">path</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">split_f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">ts_file</span><span class="p">)</span>
        
        <span class="n">outputs</span><span class="p">[</span><span class="s">&quot;cor_mat_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;cor_mat_&#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s">&#39;.npy&#39;</span><span class="p">)</span>
        
        <span class="n">outputs</span><span class="p">[</span><span class="s">&quot;conf_cor_mat_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;conf_cor_mat_&#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s">&#39;.npy&#39;</span><span class="p">)</span>
        
        <span class="n">outputs</span><span class="p">[</span><span class="s">&quot;Z_cor_mat_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;Z_cor_mat_&#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s">&#39;.npy&#39;</span><span class="p">)</span>
        
        <span class="c">#outputs[&quot;Z_conf_cor_mat_file&quot;] = os.path.abspath(&#39;Z_conf_cor_mat_&#39; + fname + &#39;.npy&#39;)</span>
        
        <span class="k">print</span> <span class="n">outputs</span>
        
        <span class="k">return</span> <span class="n">outputs</span>

        
        <span class="c">################################################################################# SelectNonNAN ######################################################################################################################</span>
 </div>
<span class="k">class</span> <span class="nc">SelectNonNANInputSpec</span><span class="p">(</span><span class="n">BaseInterfaceInputSpec</span><span class="p">):</span>
    
    <span class="n">sess_ts_files</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Numpy files with time series to be correlated&#39;</span><span class="p">,</span><span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">sess_labels_files</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Name of the nodes (used only if plot = true)&#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    
<span class="k">class</span> <span class="nc">SelectNonNANOutputSpec</span><span class="p">(</span><span class="n">TraitedSpec</span><span class="p">):</span>
    
    <span class="n">select_ts_files</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Numpy files with selected time series &#39;</span><span class="p">,</span><span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">select_labels_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&quot;npy file containing the Z-values (after Fisher&#39;s R-to-Z trasformation) of correlation&quot;</span><span class="p">)</span>
    
<span class="k">class</span> <span class="nc">SelectNonNAN</span><span class="p">(</span><span class="n">BaseInterface</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select time series based on NaN</span>
<span class="sd">    TODO: finally no used</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">input_spec</span> <span class="o">=</span> <span class="n">SelectNonNANInputSpec</span>
    <span class="n">output_spec</span> <span class="o">=</span> <span class="n">SelectNonNANOutputSpec</span>

    <span class="k">def</span> <span class="nf">_run_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runtime</span><span class="p">):</span>
                   
                  
        <span class="k">print</span> <span class="s">&#39;in compute_conf_correlation_matrix&#39;</span>
        
        <span class="n">sess_ts_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">sess_ts_files</span>
        <span class="n">labels_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">sess_labels_files</span>
        
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sess_ts_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            
            <span class="k">print</span> <span class="s">&quot;Warning, could not find sess_ts_files&quot;</span>
            
            <span class="k">return</span> <span class="n">runtime</span>
            
            
        <span class="n">path</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">split_f</span><span class="p">(</span><span class="n">sess_ts_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="n">list_sess_ts</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">ts_file</span> <span class="ow">in</span> <span class="n">sess_ts_files</span><span class="p">:</span>
            
            <span class="k">print</span> <span class="s">&#39;load data&#39;</span>
            
            <span class="n">data_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ts_file</span><span class="p">)</span>
            
            <span class="k">print</span> <span class="n">data_matrix</span><span class="o">.</span><span class="n">shape</span>
            
            <span class="n">list_sess_ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_matrix</span><span class="p">)</span>
            
        <span class="n">subj_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">list_sess_ts</span><span class="p">),</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="n">subj_ts</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">subj_ts</span><span class="p">)</span> <span class="o">==</span> <span class="bp">True</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">subj_ts</span><span class="p">)</span> <span class="o">==</span> <span class="bp">True</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">subj_ts</span><span class="p">)</span> <span class="o">==</span> <span class="bp">True</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="n">good_trigs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">subj_ts</span><span class="p">)</span> <span class="o">==</span> <span class="bp">True</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
        
        <span class="n">select_subj_ts</span> <span class="o">=</span> <span class="n">subj_ts</span><span class="p">[</span><span class="n">good_trigs</span><span class="p">,:,:]</span>
       
        <span class="k">print</span> <span class="n">select_subj_ts</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">select_ts_files</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i_trig</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">select_subj_ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        
            <span class="n">select_ts_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;select_&#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_trig</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;.npy&#39;</span><span class="p">)</span>
            
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">select_ts_file</span><span class="p">,</span><span class="n">select_subj_ts</span><span class="p">[</span><span class="n">i_trig</span><span class="p">,:,:])</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">select_ts_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">select_ts_file</span><span class="p">)</span>
            
            
        <span class="c">### check if all labels_files are identical</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            
            <span class="k">print</span> <span class="s">&quot;Warning, could not find sess_ts_files&quot;</span>
            
            <span class="k">return</span> <span class="n">runtime</span>
          
        <span class="n">select_labels_file</span> <span class="o">=</span> <span class="n">labels_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">select_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">select_labels_file</span><span class="p">),</span><span class="n">dtype</span> <span class="o">=</span> <span class="s">&#39;str&#39;</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="n">select_labels</span>
        <span class="mi">0</span><span class="o">/</span><span class="mi">0</span>
        <span class="n">labels_files</span>
        
        <span class="k">return</span> <span class="n">runtime</span>
        
    <span class="k">def</span> <span class="nf">_list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        
        <span class="n">outputs</span><span class="p">[</span><span class="s">&quot;select_ts_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_ts_files</span>
        
        <span class="k">print</span> <span class="n">outputs</span>
        
        <span class="k">return</span> <span class="n">outputs</span>

<span class="c">############################################# used in run_mean_correl ###############################################################################</span>

<span class="c">##################################################### PrepareMeanCorrel ###############################################################################</span>

<span class="kn">from</span> <span class="nn">neuropype_graph.utils_cor</span> <span class="kn">import</span> <span class="n">return_corres_correl_mat</span>

<span class="k">class</span> <span class="nc">PrepareMeanCorrelInputSpec</span><span class="p">(</span><span class="n">BaseInterfaceInputSpec</span><span class="p">):</span>
    
    <span class="c">#print &quot;in PrepareMeanCorrelInputSpec&quot;</span>
    
    <span class="n">gm_mask_coords_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;reference coordinates&#39;</span><span class="p">,</span><span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                
    <span class="n">cor_mat_files</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Numpy files with correlation matrices gm_mask_coords&#39;</span><span class="p">,</span><span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">coords_files</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Txt files with coordinates (corresponding to the space also described in &#39;</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="n">labels_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;reference labels&#39;</span><span class="p">,</span><span class="n">mandatory</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    
    <span class="n">plot_mat</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">usedefault</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">mandatory</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
    
<span class="k">class</span> <span class="nc">PrepareMeanCorrelOutputSpec</span><span class="p">(</span><span class="n">TraitedSpec</span><span class="p">):</span>
    
    <span class="c">#print &quot;in PrepareMeanCorrelOutputSpec&quot;</span>
    
    <span class="n">group_cor_mat_matrix_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&quot;npy file containing all correlation matrices in 3D&quot;</span><span class="p">)</span>
    
    <span class="n">sum_cor_mat_matrix_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&quot;npy file containing the sum of all correlation matrices&quot;</span><span class="p">)</span>
    
    <span class="n">sum_possible_edge_matrix_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&quot;npy file containing the number of correlation matrices where both nodes where actually defined in the mask&quot;</span><span class="p">)</span>
    
    <span class="n">avg_cor_mat_matrix_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&quot;npy file containing the average of all correlation matrices&quot;</span><span class="p">)</span>
    
<span class="k">class</span> <span class="nc">PrepareMeanCorrel</span><span class="p">(</span><span class="n">BaseInterface</span><span class="p">):</span>
    
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">os</span>

    <span class="c">#import nibabel as nib</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decription:</span>
<span class="sd">    </span>
<span class="sd">    Return average of correlation values within the same common space (defined in gm_mask_coords), only when the nodes are defined for a given values </span>
<span class="sd">    </span>
<span class="sd">    Input:</span>
<span class="sd">    </span>
<span class="sd">    gm_mask_coords_file</span>
<span class="sd">        type = File, exists=True, desc=&#39;reference coordinates&#39;,mandatory=True</span>
<span class="sd">                </span>
<span class="sd">    cor_mat_files</span>
<span class="sd">        type = List of Files, exists=True, desc=&#39;Numpy files with correlation matrices gm_mask_coords&#39;,mandatory=True</span>

<span class="sd">    coords_files:</span>
<span class="sd">        type = List of Files, exists=True, desc=&#39;Txt files with coordinates (corresponding to the space also described in &#39;, mandatory=True</span>
<span class="sd">    </span>
<span class="sd">    labels_file:</span>
<span class="sd">        type = File, exists=True, desc=&#39;reference labels&#39;,mandatory=False</span>
<span class="sd">    </span>
<span class="sd">    plot_mat:</span>
<span class="sd">        type = Bool; default = True, usedefault = True, mandatory = False</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">    Outputs: </span>
<span class="sd">    </span>
<span class="sd">    group_cor_mat_matrix_file: </span>
<span class="sd">        type = File,exists=True, desc=&quot;npy file containing all correlation matrices in 3D&quot;</span>
<span class="sd">    </span>
<span class="sd">    sum_cor_mat_matrix_file</span>
<span class="sd">        type = File,exists=True, desc=&quot;npy file containing the sum of all correlation matrices&quot;</span>
<span class="sd">    </span>
<span class="sd">    sum_possible_edge_matrix_file:</span>
<span class="sd">        type = File, exists=True, desc=&quot;npy file containing the number of correlation matrices where both nodes where actually defined in the mask&quot;</span>
<span class="sd">    </span>
<span class="sd">    avg_cor_mat_matrix_file:</span>
<span class="sd">        type = File, exists=True, desc=&quot;npy file containing the average of all correlation matrices&quot;</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">input_spec</span> <span class="o">=</span> <span class="n">PrepareMeanCorrelInputSpec</span>
    <span class="n">output_spec</span> <span class="o">=</span> <span class="n">PrepareMeanCorrelOutputSpec</span>

    <span class="k">def</span> <span class="nf">_run_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runtime</span><span class="p">):</span>
                
            <span class="n">gm_mask_coords_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">gm_mask_coords_file</span>
            <span class="n">cor_mat_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">cor_mat_files</span>
            <span class="n">coords_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">coords_files</span>
            <span class="n">labels_file</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">labels_file</span>
            <span class="n">plot_mat</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">plot_mat</span>
            
            <span class="k">print</span> <span class="s">&#39;loading gm mask corres&#39;</span>
            
            <span class="n">gm_mask_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">gm_mask_coords_file</span><span class="p">),</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
            
            <span class="k">print</span> <span class="n">gm_mask_coords</span>
            <span class="k">print</span> <span class="n">gm_mask_coords</span><span class="o">.</span><span class="n">shape</span>
            
            <span class="c">#### read matrix from the first group</span>
            <span class="c">#print Z_cor_mat_files</span>
            
            <span class="n">sum_cor_mat_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">gm_mask_coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">gm_mask_coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">sum_cor_mat_matrix</span><span class="o">.</span><span class="n">shape</span>
            
            <span class="n">sum_possible_edge_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">gm_mask_coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">gm_mask_coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">sum_possible_edge_matrix</span><span class="o">.</span><span class="n">shape</span>
            
                    
            <span class="n">group_cor_mat_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">gm_mask_coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">gm_mask_coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">cor_mat_files</span><span class="p">)),</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">group_cor_mat_matrix</span><span class="o">.</span><span class="n">shape</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cor_mat_files</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_files</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot;warning, length of cor_mat_files, coords_files are imcompatible {} {} {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cor_mat_files</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">coords_files</span><span class="p">))</span>
            
            <span class="k">for</span> <span class="n">index_file</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cor_mat_files</span><span class="p">)):</span>
                
                <span class="k">print</span> <span class="n">cor_mat_files</span><span class="p">[</span><span class="n">index_file</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cor_mat_files</span><span class="p">[</span><span class="n">index_file</span><span class="p">])</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">coords_files</span><span class="p">[</span><span class="n">index_file</span><span class="p">]):</span>
                
                    <span class="n">Z_cor_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cor_mat_files</span><span class="p">[</span><span class="n">index_file</span><span class="p">])</span>
                    <span class="k">print</span> <span class="n">Z_cor_mat</span><span class="o">.</span><span class="n">shape</span>
                    
                    
                    <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">coords_files</span><span class="p">[</span><span class="n">index_file</span><span class="p">]),</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
                    
                    <span class="k">print</span> <span class="n">coords</span>
                    <span class="k">print</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span>
                                        
                    <span class="n">corres_cor_mat</span><span class="p">,</span><span class="n">possible_edge_mat</span> <span class="o">=</span> <span class="n">return_corres_correl_mat</span><span class="p">(</span><span class="n">Z_cor_mat</span><span class="p">,</span><span class="n">coords</span><span class="p">,</span><span class="n">gm_mask_coords</span><span class="p">)</span>
                    
                    
                    <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">corres_cor_mat</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                    
                    <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">possible_edge_mat</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                    
                    <span class="n">sum_cor_mat_matrix</span> <span class="o">+=</span> <span class="n">corres_cor_mat</span>
                    
                    <span class="n">sum_possible_edge_matrix</span> <span class="o">+=</span> <span class="n">possible_edge_mat</span>
                    
                    
                    <span class="n">group_cor_mat_matrix</span><span class="p">[:,:,</span><span class="n">index_file</span><span class="p">]</span> <span class="o">=</span> <span class="n">corres_cor_mat</span>
                    
                    
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;Warning, one or more files between &quot;</span> <span class="o">+</span> <span class="n">cor_mat_files</span><span class="p">[</span><span class="n">index_file</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;, &#39;</span> <span class="o">+</span> <span class="n">coords_files</span><span class="p">[</span><span class="n">index_file</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot; do not exists&quot;</span>
                
                
            <span class="bp">self</span><span class="o">.</span><span class="n">group_cor_mat_matrix_file</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;group_cor_mat_matrix.npy&#39;</span><span class="p">)</span>
            
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_cor_mat_matrix_file</span><span class="p">,</span><span class="n">group_cor_mat_matrix</span><span class="p">)</span>
            
            
            <span class="k">print</span> <span class="s">&#39;saving sum cor_mat matrix&#39;</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">sum_cor_mat_matrix_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;sum_cor_mat_matrix.npy&#39;</span><span class="p">)</span>
            
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sum_cor_mat_matrix_file</span><span class="p">,</span><span class="n">sum_cor_mat_matrix</span><span class="p">)</span>
            
            <span class="k">print</span> <span class="s">&#39;saving sum_possible_edge matrix&#39;</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">sum_possible_edge_matrix_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;sum_possible_edge_matrix.npy&#39;</span><span class="p">)</span>
            
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sum_possible_edge_matrix_file</span><span class="p">,</span><span class="n">sum_possible_edge_matrix</span><span class="p">)</span>
            
            <span class="k">print</span> <span class="s">&#39;saving avg_cor_mat_matrix&#39;</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">avg_cor_mat_matrix_file</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;avg_cor_mat_matrix.npy&#39;</span><span class="p">)</span>
            
            <span class="n">avg_cor_mat_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">gm_mask_coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">gm_mask_coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span><span class="p">)</span>
            
            
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sum_possible_edge_matrix</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            
                    <span class="n">avg_cor_mat_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sum_cor_mat_matrix</span><span class="p">,</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sum_possible_edge_matrix</span><span class="p">,</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span><span class="p">))</span>
                            
                    <span class="n">avg_cor_mat_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">avg_cor_mat_matrix</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    
                    <span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">avg_cor_mat_matrix</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">avg_cor_mat_matrix</span><span class="p">)</span>
                    
                    
                    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avg_cor_mat_matrix_file</span><span class="p">,</span><span class="n">avg_cor_mat_matrix</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;!!!!!!!!!!!!!!!!!!!!!!Breaking!!!!!!!!!!!!!!!!!!!!!!!!, found 0 elements in sum_cor_mat_matrix&quot;</span>
                    
                    <span class="k">print</span> <span class="n">sum_possible_edge_matrix</span>
                    <span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sum_possible_edge_matrix</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sum_possible_edge_matrix</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
                    
                    <span class="k">return</span>
                
                
            <span class="k">if</span> <span class="n">plot_mat</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                
                <span class="k">if</span> <span class="n">isdefined</span><span class="p">(</span><span class="n">labels_file</span><span class="p">):</span>
                        
                    <span class="k">print</span> <span class="s">&#39;extracting node labels&#39;</span>
                        
                    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">labels_file</span><span class="p">)]</span>
                    <span class="k">print</span> <span class="n">labels</span>
                    
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
                
                <span class="c">#### heatmap </span>
                
                <span class="k">print</span> <span class="s">&#39;plotting Z_cor_mat heatmap&#39;</span>
                
                <span class="n">plot_heatmap_avg_cor_mat_file</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;heatmap_avg_cor_mat.eps&#39;</span><span class="p">)</span>
                
                <span class="n">plot_cormat</span><span class="p">(</span><span class="n">plot_heatmap_avg_cor_mat_file</span><span class="p">,</span><span class="n">avg_cor_mat_matrix</span><span class="p">,</span><span class="n">list_labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">)</span>
                
                
            <span class="k">return</span> <span class="n">runtime</span>
                    

    <span class="k">def</span> <span class="nf">_list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        
        <span class="n">outputs</span><span class="p">[</span><span class="s">&quot;group_cor_mat_matrix_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_cor_mat_matrix_file</span>
        <span class="n">outputs</span><span class="p">[</span><span class="s">&quot;sum_cor_mat_matrix_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sum_cor_mat_matrix_file</span>
        <span class="n">outputs</span><span class="p">[</span><span class="s">&quot;sum_possible_edge_matrix_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sum_possible_edge_matrix_file</span>
        <span class="n">outputs</span><span class="p">[</span><span class="s">&quot;avg_cor_mat_matrix_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_cor_mat_matrix_file</span>
        
        <span class="c">#print outputs</span>
        
        <span class="k">return</span> <span class="n">outputs</span>



<span class="c">##################################################### PreparePermutMeanCorrel ###############################################################################</span>

<span class="k">class</span> <span class="nc">PreparePermutMeanCorrelInputSpec</span><span class="p">(</span><span class="n">BaseInterfaceInputSpec</span><span class="p">):</span>
       
    <span class="n">cor_mat_files</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Numpy files with correlation matrices gm_mask_coords&#39;</span><span class="p">,</span><span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">permut_group_sizes</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Int</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s">&#39;How to split the groups after shuffling&#39;</span><span class="p">,</span> <span class="n">mandatory</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
    
    <span class="n">seed</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">usedefault</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">decs</span> <span class="o">=</span> <span class="s">&#39;Start of random process&#39;</span><span class="p">)</span>
    
    <span class="c">#variance_adjst = traits.Bool(False, usedefault = True, desc = &quot;is between-subject variance adjusted taken into account?&quot;)</span>
    
    
<span class="k">class</span> <span class="nc">PreparePermutMeanCorrelOutputSpec</span><span class="p">(</span><span class="n">TraitedSpec</span><span class="p">):</span>
    
    <span class="n">permut_mean_cormat_files</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span><span class="n">desc</span><span class="o">=</span><span class="s">&quot;npy files containing the average of permuted correlation matrices&quot;</span><span class="p">)</span>
    
<span class="k">class</span> <span class="nc">PreparePermutMeanCorrel</span><span class="p">(</span><span class="n">BaseInterface</span><span class="p">):</span>
    
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">os</span>

    <span class="c">#import nibabel as nib</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return average of correlation values after shuffling orig datasets</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">input_spec</span> <span class="o">=</span> <span class="n">PreparePermutMeanCorrelInputSpec</span>
    <span class="n">output_spec</span> <span class="o">=</span> <span class="n">PreparePermutMeanCorrelOutputSpec</span>

    <span class="k">def</span> <span class="nf">_run_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runtime</span><span class="p">):</span>
               
            <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">seed</span>
            
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
            
            <span class="n">cormats</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cor_mat_file</span><span class="p">)</span> <span class="k">for</span> <span class="n">cor_mat_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">cor_mat_files</span><span class="p">]</span>
            
            <span class="k">print</span> <span class="n">cormats</span>
            
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cormats</span><span class="p">)</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">permut_group_sizes</span><span class="p">),</span> <span class="s">&quot;Warning, len(cormats) {0} != sum permut_group_sizes {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cormats</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">permut_group_sizes</span><span class="p">))</span>
            
            <span class="n">subj_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cormats</span><span class="p">))</span>
            
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">subj_indexes</span><span class="p">)</span>
            
            <span class="k">print</span> <span class="n">subj_indexes</span>
            
            <span class="n">subj_indexes_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&quot;subj_indexes.txt&quot;</span><span class="p">)</span>

            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">subj_indexes_file</span><span class="p">,</span><span class="s">&quot;w+&quot;</span><span class="p">)</span>
            
            <span class="c">#f.write(subj_indexes.tolist())</span>
            
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">subj_indexes</span><span class="p">,</span><span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">)</span>
                  
                  
            <span class="n">min_index</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="n">cormats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cormats</span><span class="p">)</span>
            
            <span class="k">print</span> <span class="n">cormats</span><span class="o">.</span><span class="n">shape</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">permut_mean_cormat_files</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">cur_nb_subj_by_gender</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">permut_group_sizes</span><span class="p">):</span>
                
                <span class="k">print</span> <span class="n">cur_nb_subj_by_gender</span>
                
                <span class="n">cur_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_index</span><span class="p">,</span><span class="n">min_index</span><span class="o">+</span><span class="n">cur_nb_subj_by_gender</span><span class="p">)</span>
                
                <span class="k">print</span> <span class="n">cur_range</span>
                
                <span class="n">rand_indexes</span> <span class="o">=</span> <span class="n">subj_indexes</span><span class="p">[</span><span class="n">cur_range</span><span class="p">]</span>
                
                <span class="k">print</span> <span class="n">rand_indexes</span>
                
                <span class="c">#f.write(rand_indexes)</span>
                
                <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">rand_indexes</span><span class="p">,</span><span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">)</span>
                
                <span class="n">permut_cormats</span> <span class="o">=</span> <span class="n">cormats</span><span class="p">[</span><span class="n">rand_indexes</span><span class="p">,:,:]</span>
                
                <span class="n">permut_mean_cormat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">permut_cormats</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
                
                <span class="k">print</span> <span class="n">permut_mean_cormat</span><span class="o">.</span><span class="n">shape</span>
                
                <span class="n">permut_mean_cormat_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&quot;permut_mean_cormat_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.npy&quot;</span><span class="p">)</span>
                
                <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">permut_mean_cormat_file</span><span class="p">,</span><span class="n">permut_mean_cormat</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">permut_mean_cormat_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">permut_mean_cormat_file</span><span class="p">)</span>
                
                <span class="n">min_index</span><span class="o">+=</span><span class="n">cur_nb_subj_by_gender</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="n">runtime</span>
                    

    <span class="k">def</span> <span class="nf">_list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        
        <span class="n">outputs</span><span class="p">[</span><span class="s">&quot;permut_mean_cormat_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">permut_mean_cormat_files</span>
        
        <span class="c">#print outputs</span>
        
        <span class="k">return</span> <span class="n">outputs</span>

                    

<span class="c">#def prepare_signif_correlation_matrices(cor_mat_files,conf_cor_mat_files,coords_files,gm_mask_coords_file):</span>


    <span class="c">#import numpy as np</span>
    <span class="c">#import os</span>

    <span class="c">##import nibabel as nib</span>
    
    <span class="c">##from utils_cor import read_Pajek_corres_nodes,read_lol_file</span>
    
    <span class="c">#print &#39;loading gm mask corres&#39;</span>
    
    <span class="c">#gm_mask_coords = np.loadtxt(gm_mask_coords_file)</span>
    
    <span class="c">#print gm_mask_coords.shape</span>
        
    <span class="c">##### read matrix from the first group</span>
    <span class="c">##print Z_cor_mat_files</span>
    
    <span class="c">#sum_signif_cor_mat = np.zeros((gm_mask_coords.shape[0],gm_mask_coords.shape[0]),dtype = float)</span>
    <span class="c">#print sum_signif_cor_mat.shape</span>
    
    <span class="c">#sum_possible_edge_mat = np.zeros((gm_mask_coords.shape[0],gm_mask_coords.shape[0]),dtype = int)</span>
    <span class="c">#print sum_possible_edge_mat.shape</span>
    
    
    
    <span class="c">#group_signif_cor_mat = np.zeros((gm_mask_coords.shape[0],gm_mask_coords.shape[0],len(cor_mat_files)),dtype = float)</span>
    <span class="c">#print group_signif_cor_mat.shape</span>
    
    <span class="c">#if len(cor_mat_files) != len(coords_files):</span>
        <span class="c">#print &quot;warning, length of cor_mat_files, coords_files are imcompatible {} {} {}&quot;.format(len(cor_mat_files),len(coords_files))</span>
    
    <span class="c">#for index_file in range(len(cor_mat_files)):</span>
        
        <span class="c">#print cor_mat_files[index_file]</span>
        
        <span class="c">#if os.path.exists(cor_mat_files[index_file]) and os.path.exists(coords_files[index_file]) and os.path.exists(conf_cor_mat_files[index_file]):</span>
        
            <span class="c">#cor_mat = np.load(cor_mat_files[index_file])</span>
            <span class="c">#print cor_mat.shape</span>
            
            <span class="c">#conf_cor_mat = np.load(conf_cor_mat_files[index_file])</span>
            <span class="c">#print conf_cor_mat.shape</span>
            
            <span class="c">#signif_cor_mat = conf_cor_mat &lt; np.abs(cor_mat)</span>
            
            <span class="c">#print signif_cor_mat.shape</span>
            
            <span class="c">#coords = np.loadtxt(coords_files[index_file])</span>
            <span class="c">#print coords.shape</span>
            
            <span class="c">#corres_signif_cor_mat,possible_edge_mat = return_corres_correl_mat(signif_cor_mat,coords,gm_mask_coords)</span>
            
            <span class="c">#group_signif_cor_mat[:,:,index_file] = corres_signif_cor_mat</span>
            
            <span class="c">#sum_signif_cor_mat += corres_signif_cor_mat</span>
            
            <span class="c">#sum_possible_edge_mat += possible_edge_mat</span>
            
        <span class="c">#else:</span>
            <span class="c">#print &quot;Warning, one or more files between &quot; + cor_mat_files[index_file] + &#39;, &#39; + coords_files[index_file] + &#39;, &#39; + conf_cor_mat_files[index_file]+ &quot; do not exists&quot;</span>
        
    <span class="c">#print &#39;computing sum_signif_cor_mat&#39;</span>
    
    <span class="c">#sum_signif_cor_mat = np.sum(group_signif_cor_mat,axis = 2)</span>
    
    <span class="c">#print &#39;saving group_signif cor_mat matrix&#39;</span>
    
    <span class="c">#group_signif_cor_mat_file= os.path.abspath(&#39;group_signif_cor_mat.npy&#39;)</span>
    
    <span class="c">#np.save(group_signif_cor_mat_file,group_signif_cor_mat)</span>
    
    
    <span class="c">#print &#39;saving sum_signif cor_mat matrix&#39;</span>
    
    <span class="c">#sum_signif_cor_mat_file = os.path.abspath(&#39;sum_signif_cor_mat.npy&#39;)</span>
    
    <span class="c">#np.save(sum_signif_cor_mat_file,sum_signif_cor_mat)</span>
    
    
    <span class="c">#print &#39;saving sum_possible_edge matrix&#39;</span>
    
    <span class="c">#sum_possible_edge_mat_file = os.path.abspath(&#39;sum_possible_edge_mat.npy&#39;)</span>
    
    <span class="c">#np.save(sum_possible_edge_mat_file,sum_possible_edge_mat)</span>
    
    
    
    
    
    <span class="c">#print &#39;saving avg_cor_mat_matrix&#39;</span>
    
    <span class="c">#norm_signif_cor_mat_file  = os.path.abspath(&#39;norm_signif_cor_mat.npy&#39;)</span>
    
    <span class="c">#norm_signif_cor_mat = np.zeros((gm_mask_coords.shape[0],gm_mask_coords.shape[0]),dtype = int)</span>
    
    <span class="c">#if (np.where(np.array(sum_possible_edge_mat == 0)) != 0):</span>
    
            <span class="c">#norm_signif_cor_mat = np.divide(np.array(sum_signif_cor_mat,dtype = float),np.array(sum_possible_edge_mat,dtype = float))</span>
            
            <span class="c">#np.save(norm_signif_cor_mat_file,norm_signif_cor_mat)</span>
    
    <span class="c">#else:</span>
            <span class="c">#print &quot;!!!!!!!!!!!!!!!!!!!!!!Breaking!!!!!!!!!!!!!!!!!!!!!!!!, found 0 elements in norm_signif_cor_mat&quot;</span>
            <span class="c">#return</span>
            
    
    <span class="c">#return group_signif_cor_mat_file,sum_signif_cor_mat_file,sum_possible_edge_mat_file,norm_signif_cor_mat_file</span>
        
     
        
        
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Dmitrii Altukhov, David Meunier, Annalisa Pascarella.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>